<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #222; color: #fff; min-height: 100vh; }
        .panel { background-color: #f4f7f6; color: #333; border-radius: 6px; padding: 10px; box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1); height: 100%; }
        .panel-title { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 5px; padding-bottom: 3px; font-size: 0.9rem; }
        .chat-box, .event-log { height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px; padding: 8px; background: #fff; font-size: 0.85rem; display: flex; flex-direction: column; }
        .chat-box p { margin: 0; line-height: 1.2; word-wrap: break-word; padding-bottom: 2px; }
        .chat-box p.system { color: gray; font-style: italic; text-align: center; }
        .chat-box p.propio { font-weight: bold; color: #007bff; }
        .event-log p { margin: 0; padding-bottom: 5px; word-wrap: break-word; }
        .event-log p strong { color: #5a3a7b; }
        .action-button { width: 100%; margin-bottom: 6px; background-color: #4a4a4a; color: #fff; border: none; border-radius: 6px; padding: 8px; font-weight: bold; font-size: 0.85rem; transition: 0.2s; }
        .action-button:hover { background-color: #666; transform: translateY(-2px); }
        .codigo-box { background: #333; color: #fff; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center; gap: 8px; }
        .copy-btn { border: none; background: #555; color: #fff; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }
        .copy-btn:hover { background: #777; }
        #tablero-container span, #tablero-container-movil span { color: #555; display: flex; justify-content: center; align-items: center; height: 100%; }
    </style>
</head>
<body class="container-fluid py-2">

    <div class="text-center mb-3">
        <h4>⚔️ Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            Código: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch">
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small"><li class="list-group-item text-center">Cargando...</li></ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-container" style="height:350px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                    <span style="color:#555;">[ aquí agregaremos el tablero ]</span>
                </div>
            </div>
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div id="event-log-box" class="event-log small"></div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1 d-flex flex-column">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1"></div>
                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">➤</button>
                </div>
            </div>
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button">Moverse</button>
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Habilidades</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10); 
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);
        
        let socket; 
        const chatBoxPC = document.getElementById('chat-box-pc');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const btnSendPC = document.getElementById('chat-send-btn-pc');
        const tableroPC = document.getElementById('tablero-container');
        const eventLogBox = document.getElementById('event-log-box');

        document.addEventListener('DOMContentLoaded', () => {
            if (!ID_PARTIDA || !ID_PERSONAJE) return console.error("Faltan IDs");

            socket = io("http://127.0.0.1:5000", { transports: ['websocket'], withCredentials: true });

            cargarJugadores();
            cargarHistorialChat();
            cargarHistorialEventos(); // <--- Carga historia de IA

            if (btnSendPC) btnSendPC.addEventListener("click", enviarMensaje);
            if (inputMsgPC) inputMsgPC.addEventListener("keypress", e => { if (e.key === "Enter") enviarMensaje(); });

            socket.on("connect", () => {
                socket.emit("join_partida", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE });
            });

            socket.on("new_message", data => {
                if (data.username === "DM Gema") return; // Ignorar IA en chat normal
                const esPropio = (String(data.id_usuario) === String(USER_ID));
                const tipo = esPropio ? "propio" : "normal";
                const texto = `${data.username}: ${data.mensaje}`; 
                agregarMensaje(texto, tipo);
            });

            // LISTENER PARA IA (Panel Eventos)
            socket.on('nuevo_evento_ia', (data) => {
                agregarEvento(`<strong>DM Gema:</strong> ${data.descripcion}`);
            });
        });

        function agregarMensaje(texto, tipo = "normal") {
            const p = document.createElement("p");
            p.className = tipo;
            p.textContent = texto;
            if(chatBoxPC) { chatBoxPC.appendChild(p); chatBoxPC.scrollTop = chatBoxPC.scrollHeight; }
        }
        
        function agregarEvento(html) {
            if (!eventLogBox) return; 
            const p = document.createElement("p");
            p.innerHTML = html;
            eventLogBox.appendChild(p);
            eventLogBox.scrollTop = eventLogBox.scrollHeight;
        }

        async function cargarHistorialChat() {
            const resp = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
            const msgs = await resp.json();
            msgs.forEach(msg => {
                if (String(msg.id_usuario) === "101") return; // Ignorar IA
                const tipo = (String(msg.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                agregarMensaje(`${msg.username}: ${msg.mensaje}`, tipo);
            });
        }

        // Nueva función para cargar Eventos de la DB
        async function cargarHistorialEventos() {
            try {
                const resp = await fetch(`/api/chat/eventos/${ID_PARTIDA}`);
                const eventos = await resp.json();
                eventos.forEach(evt => {
                    agregarEvento(`<strong>DM Gema:</strong> ${evt.descripcion}`);
                });
            } catch (e) { console.error("Error cargando eventos", e); }
        }

        function enviarMensaje() {
            const msg = inputMsgPC.value.trim();
            if (!msg) return;
            socket.emit("send_message", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE, mensaje: msg });
            inputMsgPC.value = "";
        }

        async function cargarJugadores() {
             // ... (Tu código de cargar jugadores) ...
             try {
                const ul = document.getElementById("lista-jugadores");
                const r = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const j = await r.json();
                ul.innerHTML = "";
                j.forEach(p => {
                    ul.innerHTML += `<li class="list-group-item py-1">${p.personaje} (${p.clase})</li>`;
                });
             } catch(e) {}
        }
        
        function copiarCodigo() { /* ... */ }
    </script>
</body>
</html>