<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="container-fluid py-2">

    <!-- Encabezado -->
    <div class="text-center mb-3">
        <h4>‚öîÔ∏è Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            C√≥digo: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <!-- TABS MOVIL -->
    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-board" type="button">
                Tablero
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-players" type="button">
                Jugadores
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events" type="button">
                Eventos
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chat" type="button">
                Chat
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-actions" type="button">
                Acciones
            </button>
        </li>
    </ul>

    <div class="tab-content d-md-none mt-2">

        <!-- Tablero -->
        <div class="tab-pane fade show active panel" id="tab-board">
            <h6 class="panel-title">Tablero</h6>
            <div id="tablero-container-movil"
                style="height:250px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                <span style="color:#555;">[ aqu√≠ agregaremos el tablero ]</span>
            </div>
        </div>

        <!-- Jugadores -->
        <div class="tab-pane fade panel" id="tab-players">
            <h6 class="panel-title">Jugadores</h6>
            <ul id="lista-jugadores-movil" class="list-group small">
                <li class="list-group-item text-center">Cargando...</li>
            </ul>
        </div>

        <!-- Eventos -->
        <div class="tab-pane fade panel" id="tab-events">
            <h6 class="panel-title">Eventos</h6>
            <div id="eventos-movil" class="event-log small" style="max-height:200px; overflow-y:auto;"></div>
        </div>

        <!-- Chat -->
        <div class="tab-pane fade panel" id="tab-chat">
            <h6 class="panel-title">Chat</h6>
            <div id="chat-box-movil" class="chat-box small flex-grow-1"></div>
            <div class="input-group mt-2 input-group-sm">
                <input id="chat-input-movil" type="text" class="form-control" placeholder="Mensaje...">
                <button id="chat-send-btn-movil" class="btn btn-primary">‚û§</button>
            </div>
        </div>

        <!-- Acciones -->
        <div class="tab-pane fade panel" id="tab-actions">
            <h6 class="panel-title">Acciones</h6>
            <div class="d-grid gap-1">
                <button class="action-button">Moverse</button>
                <button class="action-button">Atacar</button>
                <button class="action-button">Habilidades</button>
                <button class="action-button action-equipo">Equipo</button>
                <button class="action-button action-inventario">Inventario</button>
            </div>
        </div>

    </div>


    <!-- LAYOUT ESCRITORIO -->
    <div class="row d-none d-md-flex g-2">

        <!-- Col jugadores -->
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small">
                    <li class="list-group-item text-center">Cargando...</li>
                </ul>
            </div>
        </div>

        <!-- Col tablero + eventos -->
        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-container"
                    style="height:350px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                    <span style="color:#555;">[ aqu√≠ agregaremos el tablero ]</span>
                </div>
            </div>

            <!-- Eventos -->
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div id="event-log-box" class="event-log small"></div>
            </div>
        </div>

        <!-- Chat + Acciones -->
        <div class="col-md-3 d-flex flex-column">

            <div class="panel p-2 mb-2 flex-grow-1 d-flex flex-column">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1"></div>

                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">‚û§</button>
                </div>
            </div>

            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button">Moverse</button>
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Habilidades</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
                </div>
            </div>

        </div>

    </div>


    <!-- MODAL EQUIPO / INVENTARIO -->
    <div class="modal fade" id="modalInfoPersonaje" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-medieval">
                <div class="modal-header modal-medieval-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-medieval-body" id="modalBody">
                    Cargando...
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10);
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);

        let socket;
        let modalPersonaje = null;

        const chatBoxPC = document.getElementById('chat-box-pc');
        const chatBoxMovil = document.getElementById('chat-box-movil');
        const eventLogBox = document.getElementById('event-log-box');
        const eventLogMovil = document.getElementById('eventos-movil');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const inputMsgMovil = document.getElementById('chat-input-movil');
        const tableroPC = document.getElementById('tablero-container');
        const tableroMovil = document.getElementById('tablero-container-movil');

        document.addEventListener("DOMContentLoaded", () => {

            if (!ID_PARTIDA || !ID_PERSONAJE || !USER_ID) {
                console.error("Faltan IDs esenciales");
                if (chatBoxPC) chatBoxPC.innerHTML = '<p class="system">[Error: faltan IDs]</p>';
                return;
            }

            socket = io("http://127.0.0.1:5000", {
                transports: ["websocket"],
                withCredentials: true
            });

            socket.on("connect", () => {
                console.log("Socket conectado");
                socket.emit("join_partida", {
                    id_partida: ID_PARTIDA,
                    id_personaje: ID_PERSONAJE
                });
            });

            // Eventos socket
            socket.on("system", data => {
                agregarMensaje(`[Sistema] ${data.msg}`, "system");
            });

            socket.on("new_message", data => dibujarMensajeChat(data));
            socket.on("mapa_nuevo", data => dibujarMapa(data));
            socket.on("tablero_code", data => dibujarTableroCode(data));

            socket.on("nuevo_evento_ia", data => {
                agregarEvento(`<strong>DM Gema:</strong> ${data.descripcion}`);
            });

            // Env√≠o de mensajes
            document.getElementById("chat-send-btn-pc").addEventListener("click", enviarMensaje);
            document.getElementById("chat-send-btn-movil").addEventListener("click", enviarMensaje);

            inputMsgPC.addEventListener("keypress", e => { if (e.key === "Enter") enviarMensaje(); });
            inputMsgMovil.addEventListener("keypress", e => { if (e.key === "Enter") enviarMensaje(); });

            // Botones Equipo / Inventario (m√≥vil + escritorio)
            document.querySelectorAll(".action-equipo").forEach(btn =>
                btn.addEventListener("click", cargarEquipo)
            );
            document.querySelectorAll(".action-inventario").forEach(btn =>
                btn.addEventListener("click", cargarInventario)
            );

            // Cargar datos iniciales
            cargarJugadores();
            cargarHistorialChat();
        });

        function enviarMensaje() {
            if (!socket) return;

            let mensaje = inputMsgMovil.value.trim() || inputMsgPC.value.trim();
            if (!mensaje) return;

            socket.emit("send_message", {
                id_partida: ID_PARTIDA,
                id_personaje: ID_PERSONAJE,
                mensaje
            });

            inputMsgMovil.value = "";
            inputMsgPC.value = "";
        }

        function agregarMensaje(texto, tipo = "normal", isHtml = false) {
            const p = document.createElement("p");
            p.className = tipo;

            if (isHtml) p.innerHTML = texto;
            else p.textContent = texto;

            if (chatBoxPC) {
                chatBoxPC.appendChild(p.cloneNode(true));
                chatBoxPC.scrollTop = chatBoxPC.scrollHeight;
            }
            if (chatBoxMovil) {
                chatBoxMovil.appendChild(p.cloneNode(true));
                chatBoxMovil.scrollTop = chatBoxMovil.scrollHeight;
            }
        }

        function agregarEvento(html) {
            const p1 = document.createElement("p");
            p1.innerHTML = html;
            if (eventLogBox) {
                eventLogBox.appendChild(p1);
                eventLogBox.scrollTop = eventLogBox.scrollHeight;
            }

            const p2 = document.createElement("p");
            p2.innerHTML = html;
            if (eventLogMovil) {
                eventLogMovil.appendChild(p2);
                eventLogMovil.scrollTop = eventLogMovil.scrollHeight;
            }
        }

        async function cargarHistorialChat() {
            if (chatBoxPC) chatBoxPC.innerHTML = "";
            if (chatBoxMovil) chatBoxMovil.innerHTML = "";
            if (eventLogBox) eventLogBox.innerHTML = "";
            if (eventLogMovil) eventLogMovil.innerHTML = "";

            agregarMensaje("[ Cargando historial... ]", "system");

            try {
                const resp = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
                const mensajes = await resp.json();

                mensajes.forEach(msg => {
                    
                    if (String(msg.id_usuario) === "101") {
                        agregarEvento(`<strong>DM Gema:</strong> ${msg.mensaje}`);
                        return;
                    }

                    const tipo = (String(msg.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                    const personaje = msg.nombre_personaje || msg.username || 'Sistema';
                    const username_display =
                        (msg.nombre_personaje && msg.username) ? ` (${msg.username})` : '';

                    agregarMensaje(`${personaje}${username_display}: ${msg.mensaje}`, tipo);
                });

            } catch (err) {
                console.error(err);
                agregarMensaje("[ Error al cargar historial ]", "system");
            }
        }

        function dibujarMensajeChat(data) {
            const esPropio = (String(data.id_usuario) === String(USER_ID));
            const tipo = esPropio ? "propio" : "normal";

            // DM Gema o sistema
            if (data.username === "DM Gema" || data.username === "Sistema") {
                if (data.mensaje && data.mensaje.includes("Generando")) {
                    actualizarTablero(data.mensaje, false);
                }
                agregarEvento(`<strong>${data.username}:</strong> ${data.mensaje}`);
                return;
            }

            const texto = data.nombre_personaje
                ? `${data.nombre_personaje} (${data.username}): ${data.mensaje}`
                : `${data.username}: ${data.mensaje}`;

            agregarMensaje(texto, tipo);
        }

        function dibujarMapa(data) {
            if (data.url_imagen) {
                actualizarTablero(
                    `<img src="${data.url_imagen}" style="width:100%; height:100%; object-fit:contain; border-radius:6px;">`,
                    true
                );
            } else if (data.msg) {
                actualizarTablero(data.msg, false);
            }
        }

        function dibujarTableroCode(data) {
            if (data.codigo) actualizarTablero(data.codigo, true);
            else actualizarTablero("Error: C√≥digo de tablero vac√≠o.", false);
        }

        function actualizarTablero(content, isHtml = false) {
            if (tableroPC) {
                tableroPC.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroPC.style.background = isHtml ? "none" : "#ddd";
            }
            if (tableroMovil) {
                tableroMovil.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroMovil.style.background = isHtml ? "none" : "#ddd";
            }
        }

        async function cargarJugadores() {
            try {
                const resp = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const jugadores = await resp.json();

                const ulPc = document.getElementById("lista-jugadores");
                const ulMovil = document.getElementById("lista-jugadores-movil");

                if (ulPc) ulPc.innerHTML = "";
                if (ulMovil) ulMovil.innerHTML = "";

                jugadores.forEach(j => {
                    const li = `<li class="list-group-item py-1">${j.personaje} (${j.clase})</li>`;
                    if (ulPc) ulPc.innerHTML += li;
                    if (ulMovil) ulMovil.innerHTML += li;
                });

            } catch (err) {
                console.error("Error al cargar jugadores:", err);
            }
        }

        function abrirModalInfoBase() {
            if (!modalPersonaje) {
                const modalElement = document.getElementById("modalInfoPersonaje");
                modalPersonaje = new bootstrap.Modal(modalElement);
            }
            modalPersonaje.show();
        }

        async function cargarEquipo() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/equipo/${ID_PERSONAJE}`, "Equipo Equipado", "equipo");
        }

        async function cargarInventario() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/inventario/${ID_PERSONAJE}`, "Inventario", "inventario");
        }

        async function cargarModalInfo(url, titulo, tipoVista) {
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");

            modalTitle.textContent = titulo;
            modalBody.innerHTML = "<p class='text-center text-muted'>Cargando...</p>";

            try {
                const resp = await fetch(url);
                const items = await resp.json();

                if (!Array.isArray(items) || !items.length) {
                    modalBody.innerHTML = "<p class='text-center'>No hay elementos aqu√≠.</p>";
                    return;
                }

                let html = "<ul class='list-group'>";
                items.forEach(i => {

                    const nombre = i.NOMBRE_OBJETO || i.nombre || "Objeto";
                    const cantidad = i.CANTIDAD || 1;

                    const idObj = Number(i.ID_EQUIPO);

                    html += `
                <li class="list-group-item d-flex justify-content-between align-items-center"
                    style="background:#222; color:white; border-color:#333;">
                    <div>
                        <div>${nombre}</div>
                        <small class="text-muted">x${cantidad}</small>
                    </div>
                    ${tipoVista === "equipo"
                            ? `<button class="btn btn-sm btn-desequipar ms-2"
                                       data-accion="desequipar" data-id="${idObj}">
                                    Desequipar
                               </button>`
                            : `<button class="btn btn-sm btn-equipar ms-2"
                                       data-accion="equipar" data-id="${idObj}">
                                    Equipar
                               </button>`
                        }
                </li>`;
                });
                html += "</ul>";

                modalBody.innerHTML = html;

                modalBody.querySelectorAll("button[data-accion]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const accion = btn.getAttribute("data-accion");
                        const idObj = btn.getAttribute("data-id");
                        manejarEquiparDesequipar(accion, idObj, tipoVista);
                    });
                });

            } catch (err) {
                console.error(err);
                modalBody.innerHTML = "<p class='text-danger'>Error al cargar informaci√≥n.</p>";
            }
        }


        async function manejarEquiparDesequipar(accion, idObjeto, tipoVista) {
            const url = accion === "equipar"
                ? "/api/partidas/equipo/equipar"
                : "/api/partidas/equipo/desequipar";

            try {
                const resp = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        id_personaje: Number(ID_PERSONAJE),
                        id_objeto: Number(idObjeto)
                    })
                });

                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || "Error al realizar la acci√≥n");
                }

                Swal.fire({
                    title: "Acci√≥n realizada",
                    text: accion === "equipar"
                        ? "El objeto ha sido equipado."
                        : "El objeto ha sido desequipado.",
                    icon: "success",
                    timer: 1500,
                    showConfirmButton: false
                });

                if (tipoVista === "equipo") cargarEquipo();
                else cargarInventario();

            } catch (err) {
                console.error(err);
                Swal.fire({
                    title: "Error",
                    text: err.message || "Error inesperado.",
                    icon: "error"
                });
            }
        }


        function copiarCodigo() {
            const codigo = document.getElementById("codigoPartida").textContent;
            navigator.clipboard.writeText(codigo);
            Swal.fire({
                title: "C√≥digo copiado üìã",
                text: `El c√≥digo "${codigo}" se ha copiado correctamente.`,
                icon: "success",
                background: "#1b1b1b",
                color: "#fff",
                timer: 2000,
                showConfirmButton: false
            });
        }
    </script>
</body>
</html>