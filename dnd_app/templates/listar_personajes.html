<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Personajes</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/listar.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    {% include 'partials/header.html' %}

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Mis Personajes</h1>

            <div>
                <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
                    inicio
                </a>

                <a href="{{ url_for('personajes_page') }}" class="btn btn-primary">
                    + Crear
                </a>
            </div>

        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Nivel</th>
                        <th>Fuerza</th>
                        <th>Destreza</th>
                        <th>Constitución</th>
                        <th>Inteligencia</th>
                        <th>Sabiduría</th>
                        <th>Carisma</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tabla-personajes-body">
                    <tr>
                        <td colspan="10" class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando personajes...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal principal: elegir acción -->
    <div class="modal fade" id="modalAccionPartida" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Gestión de partida</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="modalTextoPersonaje"></p>
                    <button class="btn btn-success me-2" id="btnCrearPartida">Crear</button>
                    <button class="btn btn-primary" id="btnUnirsePartida">Unirse</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: crear partida -->
    <div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Crear</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="nombrePartidaInput"
                        placeholder="Nombre de la partida">
                    <button class="btn btn-success w-100" id="btnConfirmarCrear">Crear partida</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: unirse a partida -->
    <div class="modal fade" id="modalUnirse" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Unirse a una partida existente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="codigoPartidaInput"
                        placeholder="Código de la partida">
                    <button class="btn btn-primary w-100" id="btnConfirmarUnirse">Unirse</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tbody = document.getElementById('tabla-personajes-body');

            fetch('/api/personajes/my')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se pudo obtener la lista de personajes. ¿Has iniciado sesión?');
                    }
                    return response.json();
                })
                .then(personajes => {
                    tbody.innerHTML = '';

                    if (personajes.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4">No tienes personajes. ¡Crea uno para comenzar!</td></tr>`;
                        return;
                    }

                    personajes.forEach(personaje => {
                        const id = personaje.ID_PERSONAJE || personaje.ID;

                        const filaHTML = `
                            <tr>
                                <td><strong>${personaje.NOMBRE || 'N/A'}</strong></td>
                                <td>${personaje.NIVEL || 'N/A'}</td>
                                <td>${personaje.FUERZA || 'N/A'}</td>
                                <td>${personaje.DESTREZA || 'N/A'}</td>
                                <td>${personaje.CONSTITUCION || 'N/A'}</td>
                                <td>${personaje.INTELIGENCIA || 'N/A'}</td>
                                <td>${personaje.SABIDURIA || 'N/A'}</td>
                                <td>${personaje.CARISMA || 'N/A'}</td>
                                <td><span class="badge bg-success">${personaje.ESTADO || 'Activo'}</span></td>
                                <td class="text-center">
                                    <a href="/personajes/detalle/${id}" class="btn btn-sm btn-info">Ver</a>
                                    <button class="btn btn-sm btn-warning" onclick="irAPartida(${id}, '${personaje.NOMBRE}')">Partida</button>
                                    <button class="btn btn-sm btn-danger">Eliminar</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += filaHTML;
                    });
                })
                .catch(error => {
                    console.error('Error al cargar personajes:', error);
                    Swal.fire({
                        title: "Error al cargar personajes",
                        text: "No se pudo obtener la lista de personajes. Verifica tu sesión o conexión.",
                        icon: "error",
                        confirmButtonColor: "#c0a060"
                    });
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-danger"><strong>Error:</strong> ${error.message}</td></tr>`;
                });
        });

        let personajeActual = null;

        async function irAPartida(idPersonaje, nombrePersonaje) {
            personajeActual = { id: idPersonaje, nombre: nombrePersonaje };

            try {
                const resp = await fetch(`/api/partidas/ir/${idPersonaje}`);
                const data = await resp.json();

                if (data.status === "en_partida") {
                    window.location.href = `/api/partidas/partida/${data.id_partida}`;
                    return;
                }

                // Mostrar modal si no está en partida
                if (data.status === "sin_partida") {
                    document.getElementById("modalTextoPersonaje").textContent =
                        `${nombrePersonaje} no está en ninguna partida.`;
                    const modal = new bootstrap.Modal(document.getElementById("modalAccionPartida"));
                    modal.show();
                }
            } catch (error) {
                Swal.fire({
                    title: "Error al gestionar la partida",
                    text: "Ocurrió un problema al intentar conectar con la partida.",
                    icon: "error",
                    confirmButtonColor: "#c0a060"
                });
            }
        }

        // --- Eventos de los botones de los modales ---
        document.getElementById("btnCrearPartida").addEventListener("click", () => {
            const modalAccion = bootstrap.Modal.getInstance(document.getElementById("modalAccionPartida"));
            modalAccion.hide();
            new bootstrap.Modal(document.getElementById("modalCrear")).show();
        });

        document.getElementById("btnUnirsePartida").addEventListener("click", () => {
            const modalAccion = bootstrap.Modal.getInstance(document.getElementById("modalAccionPartida"));
            modalAccion.hide();
            new bootstrap.Modal(document.getElementById("modalUnirse")).show();
        });

        document.getElementById("btnConfirmarCrear").addEventListener("click", async () => {
            const nombrePartida = document.getElementById("nombrePartidaInput").value.trim();
            if (!nombrePartida) {
                Swal.fire({
                    title: "Campo obligatorio",
                    text: "Debes ingresar un nombre para la partida.",
                    icon: "warning",
                    confirmButtonColor: "#c0a060"
                });
                return;
            }

            const resp = await fetch("/api/partidas/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_personaje: personajeActual.id,
                    nombre_partida: nombrePartida
                }),
            });

            const result = await resp.json();
            if (resp.ok) {
                Swal.fire({
                    title: "¡Partida creada!",
                    text: "Tu partida fue creada correctamente.",
                    icon: "success",
                    confirmButtonColor: "#c0a060"
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    title: "Error al crear partida",
                    text: result.error || "No se pudo crear la partida. Intenta nuevamente.",
                    icon: "error",
                    confirmButtonColor: "#c0a060"
                });
            }
        });

        document.getElementById("btnConfirmarUnirse").addEventListener("click", async () => {
            const codigo = document.getElementById("codigoPartidaInput").value.trim();
            if (!codigo) {
                Swal.fire({
                    title: "Código faltante",
                    text: "Debes ingresar el código de la partida para unirte.",
                    icon: "warning",
                    confirmButtonColor: "#c0a060"
                });
                return;
            }

            const resp = await fetch("/api/partidas/join", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_personaje: personajeActual.id,
                    codigo: codigo
                }),
            });

            const result = await resp.json();
            if (resp.ok) {
                Swal.fire({
                    title: "¡Unido con éxito!",
                    text: "Te has unido correctamente a la partida.",
                    icon: "success",
                    confirmButtonColor: "#c0a060"
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    title: "Error al unirse a la partida",
                    text: result.error || "El código ingresado no es válido o la partida no existe.",
                    icon: "error",
                    confirmButtonColor: "#c0a060"
                });
            }
        });



    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>