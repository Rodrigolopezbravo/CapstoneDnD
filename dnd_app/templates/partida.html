<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="container-fluid py-2">

    <div class="text-center mb-3">
        <h4>‚öîÔ∏è Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            C√≥digo: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab"
                data-bs-target="#tab-board">Tablero</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#tab-players">Jugadores</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events">Eventos</button>
        </li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chat">Chat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#tab-actions">Acciones</button></li>
    </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch">
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small">
                    <li class="list-group-item text-center">Cargando...</li>
                </ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-container"
                    style="height:350px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                    <span style="color:#555;">[ aqu√≠ agregaremos el tablero ]</span>
                </div>
            </div>
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div class="event-log small">
                    <p class="text-muted">[ En desarrollo ]</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1">
                </div>
                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">‚û§</button>
                </div>
            </div>

            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Huir</button>
                    <button class="action-button">Habilidad</button>
                    <button class="action-button">Objeto</button>
                    <button class="action-button">Dialogar</button>
                    <button class="action-button">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content d-md-none mt-2">
        <div class="tab-pane fade show active panel" id="tab-board">
            <h6 class="panel-title">Tablero</h6>
            <div id="tablero-container-movil"
                style="height:250px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                <span style="color:#555;">[ aqu√≠ agregaremos el tablero ]</span>
            </div>
        </div>

        <div class="tab-pane fade panel" id="tab-players">
            <h6 class="panel-title">Jugadores</h6>
            <ul id="lista-jugadores-movil" class="list-group small">
                <li class="list-group-item text-center">Cargando...</li>
            </ul>
        </div>

        <div class="tab-pane fade panel" id="tab-chat">
            <h6 class="panel-title">Chat</h6>
            <div id="chat-box-movil" class="chat-box small flex-grow-1">
            </div>
            <div class="input-group mt-2 input-group-sm">
                <input id="chat-input-movil" type="text" class="form-control" placeholder="Mensaje...">
                <button id="chat-send-btn-movil" class="btn btn-primary">‚û§</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // *** VARIABLES DE CONTEXTO OBTENIDAS DEL SERVIDOR ***
        // Estas l√≠neas toman los valores de la funci√≥n ver_partida en partidas.py
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10);
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);

        // --- Elementos del Chat (Definidos aqu√≠) ---
        let socket;
        const chatBoxPC = document.getElementById('chat-box-pc');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const btnSendPC = document.getElementById('chat-send-btn-pc');
        const tableroPC = document.getElementById('tablero-container');

        const chatBoxMovil = document.getElementById('chat-box-movil');
        const inputMsgMovil = document.getElementById('chat-input-movil');
        const btnSendMovil = document.getElementById('chat-send-btn-movil');
        const tableroMovil = document.getElementById('tablero-container-movil');


        document.addEventListener('DOMContentLoaded', () => {

            // 1. Inicializaci√≥n de Socket.IO
            if (ID_PARTIDA === 0 || ID_PERSONAJE === 0 || USER_ID === 0) {
                console.error("Error: Falta ID_PARTIDA, ID_PERSONAJE o USER_ID. No se inicializa el socket.");
                if (chatBoxPC) chatBoxPC.innerHTML = '<p class="system">[Error Cr√≠tico: Faltan IDs de usuario/personaje/partida.]</p>';
                return;
            }

            socket = io("http://127.0.0.1:5000", {
                transports: ['websocket'],
                withCredentials: true
            });

            // 2. Cargar datos iniciales
            cargarJugadores();
            cargarHistorialChat();

            // 3. Configurar Listeners de Clicks (Env√≠o de Mensajes)
            if (btnSendPC) btnSendPC.addEventListener("click", enviarMensaje);
            if (inputMsgPC) inputMsgPC.addEventListener("keypress", e => {
                if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); }
            });
            if (btnSendMovil) btnSendMovil.addEventListener("click", enviarMensaje);
            if (inputMsgMovil) inputMsgMovil.addEventListener("keypress", e => {
                if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); }
            });

            // 4. Conexi√≥n del Socket
            socket.on("connect", () => {
                console.log("Socket conectado");
                socket.emit("join_partida", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE });
            });

            // 5. Eventos de Recepci√≥n (new_message, tablero_code, etc.)
            socket.on("connected", data => { console.log("Usuario autenticado:", data); });
            socket.on("system", data => { agregarMensaje(`[Sistema] ${data.msg}`, "system"); });

            socket.on("new_message", data => {
                const esPropio = (String(data.id_usuario) === String(USER_ID));
                const tipo = esPropio ? "propio" :
                    (data.username === "Gemini" || data.username === "Sistema") ? "system" : "normal";

                const texto = data.nombre_personaje
                    ? `${data.nombre_personaje} (${data.username}): ${data.mensaje}`
                    : `${data.username}: ${data.mensaje}`;

                agregarMensaje(texto, tipo);

                if (data.username === "Sistema" && data.mensaje.includes("Generando")) {
                    actualizarTablero(data.mensaje, false);
                }
            });

            socket.on("error", data => { console.error("Error de Socket:", data.msg); agregarMensaje(`[Error] ${data.msg}`, "system"); });

            // --- Funciones del Tablero (Recibir contenido) ---
            socket.on("mapa_nuevo", data => {
                if (data.url_imagen) {
                    actualizarTablero(`<img src="${data.url_imagen}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">`, true);
                } else if (data.msg) {
                    actualizarTablero(data.msg, false);
                }
            });

            socket.on("tablero_code", data => {
                if (data.codigo) {
                    actualizarTablero(data.codigo, true); // Inyecta el c√≥digo como HTML
                } else {
                    actualizarTablero("Error: C√≥digo de tablero vac√≠o.", false);
                }
            });

            socket.on("joined", data => { console.log("Unido a la sala:", data.room); });


        }); // FIN DOMContentLoaded

        // --- Funciones Globales ---

        function agregarMensaje(texto, tipo = "normal", isHtml = false) {
            const p = document.createElement("p");
            p.className = tipo;
            if (isHtml) {
                p.innerHTML = texto;
            } else {
                p.textContent = texto;
            }

            if (chatBoxPC) {
                chatBoxPC.appendChild(p.cloneNode(true));
                chatBoxPC.scrollTop = chatBoxPC.scrollHeight;
            }
            if (chatBoxMovil) {
                chatBoxMovil.appendChild(p.cloneNode(true));
                chatBoxMovil.scrollTop = chatBoxMovil.scrollHeight;
            }
        }

        async function cargarHistorialChat() {
            if (chatBoxPC) chatBoxPC.innerHTML = "";
            if (chatBoxMovil) chatBoxMovil.innerHTML = "";

            agregarMensaje("[ Cargando historial... ]", "system");
            try {
                const resp = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
                const mensajes = await resp.json();

                if (mensajes.length === 0) {
                    agregarMensaje("[ Sin mensajes anteriores ]", "system");
                    return;
                }

                mensajes.forEach(msg => {
                    const tipo = (String(msg.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                    const personaje = msg.nombre_personaje || msg.username || 'Sistema';
                    const username_display = (msg.nombre_personaje && msg.username) ? ` (${msg.username})` : '';
                    const texto = `${personaje}${username_display}: ${msg.mensaje}`;

                    agregarMensaje(texto, tipo);
                });

            } catch (err) {
                console.error("Error al cargar el historial de chat:", err);
                agregarMensaje("[ Error al cargar el historial ]", "system");
            }
        }

        function enviarMensaje() {
            const inputElement = document.activeElement === inputMsgMovil ? inputMsgMovil : inputMsgPC;
            if (!inputElement || !socket) return;

            const mensaje = inputElement.value.trim();
            // *** ARREGLO CLAVE: Se verifica que los IDs sean v√°lidos para enviar el mensaje ***
            if (!mensaje || ID_PARTIDA === 0 || ID_PERSONAJE === 0) {
                console.error("No se puede enviar el mensaje: ID_PARTIDA, ID_PERSONAJE o Mensaje est√° vac√≠o.");
                if (ID_PERSONAJE === 0) {
                    Swal.fire({
                        title: "No puedes enviar mensajes",
                        text: "No tienes un personaje asignado en esta partida.",
                        icon: "warning",
                        background: "#1b1b1b",
                        color: "#fff",
                        confirmButtonColor: "#b8934d"
                    });
                }
                return;
            }

            // Deshabilitar temporalmente
            if (inputMsgPC) inputMsgPC.disabled = true;
            if (btnSendPC) btnSendPC.disabled = true;
            if (inputMsgMovil) inputMsgMovil.disabled = true;
            if (btnSendMovil) btnSendMovil.disabled = true;

            // *** EL DATO REQUERIDO POR EL BACKEND ES A√ëADIDO AQU√ç ***
            socket.emit("send_message", {
                id_partida: ID_PARTIDA,
                id_personaje: ID_PERSONAJE, // <--- Dato crucial para el backend
                mensaje: mensaje
            });

            inputElement.value = "";
            inputElement.focus();

            // Reactivar
            if (inputMsgPC) inputMsgPC.disabled = false;
            if (btnSendPC) btnSendPC.disabled = false;
            if (inputMsgMovil) inputMsgMovil.disabled = false;
            if (btnSendMovil) btnSendMovil.disabled = false;
        }

        function actualizarTablero(content, isHtml = false) {
            if (tableroPC) {
                tableroPC.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroPC.style.background = isHtml ? 'none' : '#ddd';
            }
            if (tableroMovil) {
                tableroMovil.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroMovil.style.background = isHtml ? 'none' : '#ddd';
            }
        }


        // Tu funci√≥n original de carga de jugadores
        async function cargarJugadores() {
            try {
                const ulPc = document.getElementById("lista-jugadores");
                const ulMovil = document.getElementById("lista-jugadores-movil");
                const resp = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const jugadores = await resp.json();

                if (ulPc) ulPc.innerHTML = "";
                if (ulMovil) ulMovil.innerHTML = "";

                if (jugadores.length === 0) {
                    if (ulPc) ulPc.innerHTML = `<li class="list-group-item text-center text-muted">No hay jugadores a√∫n</li>`;
                    if (ulMovil) ulMovil.innerHTML = ulPc.innerHTML;
                    return;
                }

                jugadores.forEach(j => {
                    const li = `<li class="list-group-item py-1">${j.personaje} (${j.clase})</li>`;
                    if (ulPc) ulPc.innerHTML += li;
                    if (ulMovil) ulMovil.innerHTML += li;
                });
            } catch (err) {
                console.error("Error al cargar jugadores:", err);
                const ulPc = document.getElementById("lista-jugadores");
                if (ulPc) ulPc.innerHTML = '<li class="list-group-item text-danger">Error al cargar</li>';
            }
        }

        function copiarCodigo() {
            const codigo = document.getElementById("codigoPartida").textContent;
            navigator.clipboard.writeText(codigo);
            Swal.fire({
                title: "C√≥digo copiado üìã",
                text: `El c√≥digo "${codigo}" se ha copiado correctamente.`,
                icon: "success",
                background: "#1b1b1b",
                color: "#fff",
                confirmButtonColor: "#b8934d",
                timer: 2000,
                showConfirmButton: false
            });
        }
    </script>
</body>