<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #222; color: #fff; min-height: 100vh; }
        .panel { background-color: #f4f7f6; color: #333; border-radius: 6px; padding: 10px; box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1); height: 100%; }
        .panel-title { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 5px; padding-bottom: 3px; font-size: 0.9rem; }
        .chat-box, .event-log { 
            height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            padding: 8px; 
            background: #fff; 
            font-size: 0.85rem; 
            display: flex; 
            flex-direction: column; 
        }
        .chat-box p { margin: 0; line-height: 1.2; word-wrap: break-word; padding-bottom: 2px; }
        .chat-box p.system { color: gray; font-style: italic; text-align: center; }
        .chat-box p.propio { font-weight: bold; color: #007bff; }
        
        /* Estilos para el log de eventos */
        .event-log p { margin: 0; padding-bottom: 5px; word-wrap: break-word; }
        .event-log p strong { color: #5a3a7b; /* Morado para DM Gema */ }
        
        .action-button { width: 100%; margin-bottom: 6px; background-color: #4a4a4a; color: #fff; border: none; border-radius: 6px; padding: 8px; font-weight: bold; font-size: 0.85rem; transition: 0.2s; }
        .action-button:hover { background-color: #666; transform: translateY(-2px); }
        .codigo-box { background: #333; color: #fff; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center; gap: 8px; }
        .copy-btn { border: none; background: #555; color: #fff; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }
        .copy-btn:hover { background: #777; }
        #tablero-container span, #tablero-container-movil span { color: #555; display: flex; justify-content: center; align-items: center; height: 100%; }
    </style>
</head>

<body class="container-fluid py-2">

    <div class="text-center mb-3">
        <h4>⚔️ Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            Código: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch">
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small"><li class="list-group-item text-center">Cargando...</li></ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-container"
                    style="height:350px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                    <span style="color:#555;">[ aquí agregaremos el tablero ]</span>
                </div>
            </div>
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div id="event-log-box" class="event-log small">
                    </div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1 d-flex flex-column">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1"></div>
                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">➤</button>
                </div>
            </div>
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Huir</button>
                    <button class="action-button">Habilidad</button>
                    <button class="action-button">Objeto</button>
                    <button class="action-button">Dialogar</button>
                    <button class="action-button">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content d-md-none mt-2">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // --- Variables Globales ---
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10); 
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);
        
        let socket; 
        const chatBoxPC = document.getElementById('chat-box-pc');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const btnSendPC = document.getElementById('chat-send-btn-pc');
        const tableroPC = document.getElementById('tablero-container');
        
        const chatBoxMovil = document.getElementById('chat-box-movil');
        const inputMsgMovil = document.getElementById('chat-input-movil');
        const btnSendMovil = document.getElementById('chat-send-btn-movil');
        const tableroMovil = document.getElementById('tablero-container-movil');
        const eventLogBox = document.getElementById('event-log-box');

        document.addEventListener('DOMContentLoaded', () => {
            
            if (ID_PARTIDA === 0 || ID_PERSONAJE === 0 || USER_ID === 0) {
                 console.error("Error: Falta ID_PARTIDA, ID_PERSONAJE o USER_ID. No se inicializa el socket.");
                 if (chatBoxPC) chatBoxPC.innerHTML = '<p class="system">[Error Crítico: Faltan IDs de usuario/personaje/partida.]</p>';
                 return;
            }

            socket = io("http://127.0.0.1:5000", {
                transports: ['websocket'],
                withCredentials: true
            });

            // Cargar datos iniciales
            cargarJugadores();
            cargarHistorialChat();

            // Configurar Listeners de Clicks
            if (btnSendPC) btnSendPC.addEventListener("click", enviarMensaje);
            if (inputMsgPC) inputMsgPC.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); } });
            if (btnSendMovil) btnSendMovil.addEventListener("click", enviarMensaje);
            if (inputMsgMovil) inputMsgMovil.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); } });

            // Conexión del Socket
            socket.on("connect", () => {
                console.log("Socket conectado");
                socket.emit("join_partida", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE });
            });

            // --- Eventos de Recepción ---
            socket.on("connected", data => { console.log("Usuario autenticado:", data); });
            socket.on("system", data => { agregarMensaje(`[Sistema] ${data.msg}`, "system"); });
            
            socket.on("new_message", data => {
                const esPropio = (String(data.id_usuario) === String(USER_ID));
                const tipo = esPropio ? "propio" : "normal";
                
                if (data.username === "DM Gema" || data.username === "Sistema") {
                    if (data.mensaje.includes("Generando")) {
                        actualizarTablero(data.mensaje, false);
                    }
                    return; 
                }
                
                const texto = data.nombre_personaje
                    ? `${data.nombre_personaje} (${data.username}): ${data.mensaje}`
                    : `${data.username}: ${data.mensaje}`;
                
                agregarMensaje(texto, tipo);
            });

            socket.on("error", data => { console.error("Error de Socket:", data.msg); agregarMensaje(`[Error] ${data.msg}`, "system"); });
            
            // Listeners del Tablero
            socket.on("mapa_nuevo", data => {
                 if (data.url_imagen) {
                    actualizarTablero(`<img src="${data.url_imagen}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">`, true);
                } else if (data.msg) {
                    actualizarTablero(data.msg, false);
                }
            });
            socket.on("tablero_code", data => {
                if (data.codigo) {
                    actualizarTablero(data.codigo, true); 
                } else {
                    actualizarTablero("Error: Código de tablero vacío.", false);
                }
            });
            socket.on("joined", data => { console.log("Unido a la sala:", data.room); });

            // *** LISTENER PARA EL PANEL DE EVENTOS ***
            socket.on('nuevo_evento_ia', (data) => {
                agregarEvento(`<strong>DM Gema:</strong> ${data.descripcion}`);
            });
            // Listener para eventos de encuentros.py
            socket.on('nuevo_evento', (data) => {
                 agregarEvento(data.descripcion);
            });

        }); // FIN DOMContentLoaded

        // --- Funciones Globales ---

        function agregarMensaje(texto, tipo = "normal", isHtml = false) {
            const p = document.createElement("p");
            p.className = tipo;
            if (isHtml) p.innerHTML = texto;
            else p.textContent = texto;
            if (chatBoxPC) {
                chatBoxPC.appendChild(p.cloneNode(true));
                chatBoxPC.scrollTop = chatBoxPC.scrollHeight;
            }
            if (chatBoxMovil) {
                chatBoxMovil.appendChild(p.cloneNode(true));
                chatBoxMovil.scrollTop = chatBoxMovil.scrollHeight;
            }
        }
        
        function agregarEvento(html) {
            if (!eventLogBox) return; 
            const p = document.createElement("p");
            p.innerHTML = html;
            eventLogBox.appendChild(p);
            eventLogBox.scrollTop = eventLogBox.scrollHeight;
        }

        async function cargarHistorialChat() {
            if (chatBoxPC) chatBoxPC.innerHTML = "";
            if (chatBoxMovil) chatBoxMovil.innerHTML = "";
            agregarMensaje("[ Cargando historial... ]", "system");
            try {
                const resp = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
                const mensajes = await resp.json();
                if (mensajes.length === 0) {
                    agregarMensaje("[ Sin mensajes anteriores ]", "system");
                    return;
                }
                mensajes.forEach(msg => {
                    if (String(msg.id_usuario) === "0") return; 
                    const tipo = (String(msg.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                    const personaje = msg.nombre_personaje || msg.username || 'Sistema'; 
                    const username_display = (msg.nombre_personaje && msg.username) ? ` (${msg.username})` : '';
                    const texto = `${personaje}${username_display}: ${msg.mensaje}`;
                    agregarMensaje(texto, tipo);
                });
            } catch (err) {
                console.error("Error al cargar el historial de chat:", err);
                agregarMensaje("[ Error al cargar el historial ]", "system");
            }
        }

        function enviarMensaje() {
            const inputElement = document.activeElement === inputMsgMovil ? inputMsgMovil : inputMsgPC;
            if (!inputElement || !socket) return; 
            const mensaje = inputElement.value.trim();
            if (!mensaje || ID_PARTIDA === 0 || ID_PERSONAJE === 0) {
                 console.error("No se puede enviar el mensaje: ID_PARTIDA o ID_PERSONAJE es 0.");
                 return;
            }
            if (inputMsgPC) inputMsgPC.disabled = true;
            if (btnSendPC) btnSendPC.disabled = true;
            if (inputMsgMovil) inputMsgMovil.disabled = true;
            if (btnSendMovil) btnSendMovil.disabled = true;

            socket.emit("send_message", {
                id_partida: ID_PARTIDA,
                id_personaje: ID_PERSONAJE,
                mensaje: mensaje
            });
            
            inputElement.value = "";
            inputElement.focus();

            if (inputMsgPC) inputMsgPC.disabled = false;
            if (btnSendPC) btnSendPC.disabled = false;
            if (inputMsgMovil) inputMsgMovil.disabled = false;
            if (btnSendMovil) btnSendMovil.disabled = false;
        }

        function actualizarTablero(content, isHtml = false) {
            if (tableroPC) {
                tableroPC.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroPC.style.background = isHtml ? 'none' : '#ddd';
            }
            if (tableroMovil) {
                tableroMovil.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroMovil.style.background = isHtml ? 'none' : '#ddd';
            }
        }

        async function cargarJugadores() {
            try {
                const ulPc = document.getElementById("lista-jugadores");
                const ulMovil = document.getElementById("lista-jugadores-movil");
                const resp = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const jugadores = await resp.json();

                if (ulPc) ulPc.innerHTML = "";
                if (ulMovil) ulMovil.innerHTML = "";
                
                if (jugadores.length === 0) {
                    if (ulPc) ulPc.innerHTML = `<li class="list-group-item text-center text-muted">No hay jugadores aún</li>`;
                    if (ulMovil) ulMovil.innerHTML = ulPc.innerHTML;
                    return;
                }

                jugadores.forEach(j => {
                    const li = `<li class="list-group-item py-1">${j.personaje} (${j.clase})</li>`;
                    if (ulPc) ulPc.innerHTML += li;
                    if (ulMovil) ulMovil.innerHTML += li;
                });
            } catch (err) {
                console.error("Error al cargar jugadores:", err);
                const ulPc = document.getElementById("lista-jugadores");
                if (ulPc) ulPc.innerHTML = '<li class="list-group-item text-danger">Error al cargar</li>';
            }
        }

        function copiarCodigo() {
            const codigo = document.getElementById("codigoPartida").textContent;
            navigator.clipboard.writeText(codigo);
            alert("Código copiado: " + codigo);
        }
    </script>
</body>

</html>