<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea tu personaje</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/personaje.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    {% include 'partials/header.html' %}

    <main class="container">
        <form class="form-container" autocomplete="off">
            <h2 class="form-title">Crea tu personaje</h2>

            <section class="section-container">
                <div class="input-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" name="nombre" placeholder="Escribe aquí el nombre" required>
                </div>
                <div class="input-group">
                    <label for="clase">Clase</label>
                    <select id="clase" name="clase">
                        <option value="">Selecciona una clase</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="raza">Raza</label>
                    <select id="raza" name="raza">
                        <option value="">Selecciona una raza</option>
                    </select>
                </div>
            </section>

            <h2 class="form-title">Atributos</h2>

            <section class="section-container">
                <div class="input-group">
                    <label for="fuerza">Fuerza</label>
                    <input type="number" id="fuerza" name="fuerza" value="8" min="8" max="17">
                </div>
                <div class="input-group">
                    <label for="destreza">Destreza</label>
                    <input type="number" id="destreza" name="destreza" value="8" min="8" max="17">
                </div>
                <div class="input-group">
                    <label for="constitucion">Constitución</label>
                    <input type="number" id="constitucion" name="constitucion" value="8" min="8" max="17">
                </div>
                <div class="input-group">
                    <label for="inteligencia">Inteligencia</label>
                    <input type="number" id="inteligencia" name="inteligencia" value="8" min="8" max="17">
                </div>
                <div class="input-group">
                    <label for="sabiduria">Sabiduría</label>
                    <input type="number" id="sabiduria" name="sabiduria" value="8" min="8" max="17">
                </div>
                <div class="input-group">
                    <label for="carisma">Carisma</label>
                    <input type="number" id="carisma" name="carisma" value="8" min="8" max="17">
                </div>
            </section>

            <button type="submit" class="submit-button">Crear Personaje</button>
        </form>
    </main>

    <script>
        async function cargarOpciones() {
            try {
                const claseSelect = document.getElementById('clase');
                const respClases = await fetch('/api/personajes/clases');
                if (respClases.ok) {
                    const clases = await respClases.json();
                    clases.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.nombre;
                        claseSelect.appendChild(option);
                    });
                } else {
                    console.error('Error al cargar clases');
                }

                const razaSelect = document.getElementById('raza');
                const respRazas = await fetch('/api/personajes/razas');
                if (respRazas.ok) {
                    const razas = await respRazas.json();
                    razas.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r.id;
                        option.textContent = r.nombre;
                        razaSelect.appendChild(option);
                    });
                } else {
                    console.error('Error al cargar razas');
                }
            } catch (error) {
                console.error('Error al conectar con el servidor:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', cargarOpciones);

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form');
            const submitButton = document.querySelector('.submit-button');
            const claseSelect = document.getElementById('clase');
            const equipoContainer = document.createElement('div');
            equipoContainer.classList.add('section-container');
            claseSelect.parentElement.parentElement.insertAdjacentElement('afterend', equipoContainer);

            const totalPuntos = 27;
            const stats = ["fuerza", "destreza", "constitucion", "inteligencia", "sabiduria", "carisma"];
            let puntosRestantes = totalPuntos;

            const marcador = document.createElement('p');
            marcador.id = 'puntos-restantes';
            marcador.style.textAlign = 'center';
            marcador.style.fontWeight = 'bold';
            marcador.style.color = 'white';
            marcador.style.marginTop = '1rem';
            marcador.style.marginBottom = '0.5rem';
            const boton = form.querySelector('.submit-button');
            form.insertBefore(marcador, boton);

            function calcularPuntos() {
                let gasto = 0;
                stats.forEach(stat => {
                    const input = document.getElementById(stat);
                    let val = parseInt(input.value);
                    if (val > 17) val = 17;
                    if (val < 8) val = 8;
                    input.value = val;
                    gasto += (val - 8);
                });

                puntosRestantes = totalPuntos - gasto;
                if (puntosRestantes < 0) puntosRestantes = 0;

                marcador.textContent = `Puntos restantes: ${puntosRestantes}`;
                if (puntosRestantes === 0) marcador.classList.add('warning');
                else marcador.classList.remove('warning');
            }

            stats.forEach(stat => {
                const input = document.getElementById(stat);
                input.dataset.prevValue = input.value;
            });

            stats.forEach(stat => {
                const input = document.getElementById(stat);
                input.addEventListener('input', () => {
                    if (puntosRestantes <= 0 && parseInt(input.value) > parseInt(input.dataset.prevValue)) {
                        input.value = input.dataset.prevValue;
                        Swal.fire({
                            title: "¡Puntos agotados!",
                            text: "Ya no puedes asignar más puntos.",
                            icon: "warning",
                            confirmButtonColor: "#c0a060"
                        });
                        return;
                    }

                    input.dataset.prevValue = input.value;
                    calcularPuntos();
                });
            });

            const opcionesClase = {
                "Guerrero": [
                    { label: "Arma principal", options: ["Alabarda", "Atarraga", "Cimitarra", "Espada corta", "Espada larga", "Espadón", "Estoque", "Hacha de batalla"] },
                    { label: "Arma secundaria o escudo", options: ["Alabarda", "Atarraga", "Cimitarra", "Espada corta", "Espada larga", "Espadón", "Estoque", "Hacha de batalla", "Escudo"] },
                    { label: "Armadura", options: ["Cota de mallas", "Cuero"] }
                ],
                "Clérigo": [
                    { label: "Arma principal", options: ["Maza", "Martillo de guerra"] },
                    { label: "Armadura", options: ["Cota de escamas", "Cota de mallas", "Cuero"] },
                    { label: "Arma secundaria", options: ["Bastón", "Daga", "Gran clava", "Hacha de mano", "Hoz", "Jabalina", "Lanza", "Martillo ligero", "Maza", "Clava", "Arco corto", "Ballesta ligera", "Dardo", "Honda"] }
                ],
                "Mago": [
                    { label: "Arma principal", options: ["Daga", "Bastón"] },
                    { label: "Armadura", options: ["Cuero"] }
                ],
                "Pícaro": [
                    { label: "Arma principal", options: ["Estoque", "Espada corta"] },
                    { label: "Arma secundaria", options: ["Arco corto", "Ballesta ligera", "Espada corta"] },
                    { label: "Armadura", options: ["Armadura de cuero", "Armadura acolchada"] }
                ]
            };

            claseSelect.addEventListener('change', () => {
                const claseNombre = claseSelect.options[claseSelect.selectedIndex].text;
                equipoContainer.innerHTML = '';
                if (claseNombre && opcionesClase[claseNombre]) {
                    equipoContainer.classList.add('equipo-inicial');
                    equipoContainer.innerHTML = `<h2 class="form-title">Equipo inicial de ${claseNombre}</h2>`;
                    opcionesClase[claseNombre].forEach((grupo, idx) => {
                        const div = document.createElement('div');
                        div.classList.add('input-group');
                        const label = document.createElement('label');
                        label.textContent = grupo.label;
                        const select = document.createElement('select');
                        select.classList.add('form-select');
                        select.id = `equipo-${idx}`;
                        grupo.options.forEach(op => {
                            const option = document.createElement('option');
                            option.value = op;
                            option.textContent = op;
                            select.appendChild(option);
                        });
                        div.appendChild(label);
                        div.appendChild(select);
                        equipoContainer.appendChild(div);
                    });
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (puntosRestantes < 0) {
                    Swal.fire({
                        title: "Distribución inválida",
                        text: "Has asignado más puntos de los permitidos. Ajusta los atributos antes de continuar.",
                        icon: "error",
                        confirmButtonColor: "#c0a060"
                    });
                    return;
                }

                if (puntosRestantes > 0) {
                    Swal.fire({
                        title: "Puntos sin asignar",
                        text: `Aún te quedan ${puntosRestantes} puntos disponibles. Asigna todos antes de crear el personaje.`,
                        icon: "warning",
                        confirmButtonColor: "#c0a060"
                    });
                    return;
                }


                submitButton.disabled = true;
                submitButton.textContent = 'Creando...';

                const equipo = [];
                equipoContainer.querySelectorAll('select').forEach(s => equipo.push(s.value));

                const data = {
                    nombre: document.getElementById('nombre').value,
                    clase: document.getElementById('clase').value,
                    raza: document.getElementById('raza').value,
                    equipo: equipo,
                    fuerza: parseInt(document.getElementById('fuerza').value),
                    destreza: parseInt(document.getElementById('destreza').value),
                    constitucion: parseInt(document.getElementById('constitucion').value),
                    inteligencia: parseInt(document.getElementById('inteligencia').value),
                    sabiduria: parseInt(document.getElementById('sabiduria').value),
                    carisma: parseInt(document.getElementById('carisma').value)
                };

                if (!data.nombre || !data.clase || !data.raza) {
                    Swal.fire({
                        title: "Campos incompletos",
                        text: "Por favor, completa todos los campos requeridos antes de crear tu personaje.",
                        icon: "warning",
                        confirmButtonColor: "#c0a060"
                    });
                    submitButton.disabled = false;
                    submitButton.textContent = 'Crear Personaje';
                    return;
                }

                try {
                    const response = await fetch('/api/personajes/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        Swal.fire({
                            title: "¡Personaje creado!",
                            text: result.message || "Tu personaje ha sido guardado correctamente.",
                            icon: "success",
                            confirmButtonColor: "#c0a060"
                        }).then(() => {
                            window.location.href = "/listar_personajes";
                        });
                        form.reset();
                        equipoContainer.innerHTML = '';
                        puntosRestantes = totalPuntos;
                        calcularPuntos();
                    } else {
                        const error = await response.json();
                        Swal.fire({
                            title: "Error al crear personaje",
                            text: error.error || "Hubo un problema al guardar el personaje. Inténtalo nuevamente.",
                            icon: "error",
                            confirmButtonColor: "#c0a060"
                        });
                    }
                } catch (error) {
                    console.error('Error de conexión:', error);
                    Swal.fire({
                        title: "Error de conexión",
                        text: "No se pudo contactar con el servidor. Verifica tu conexión a internet.",
                        icon: "error",
                        confirmButtonColor: "#c0a060"
                    });
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Crear Personaje';
                }
            });

            calcularPuntos();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>