<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #222; color: #fff; min-height: 100vh; }
        .panel { background-color: #f4f7f6; color: #333; border-radius: 6px; padding: 10px; box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1); height: 100%; }
        .panel-title { font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 5px; padding-bottom: 3px; font-size: 0.9rem; }
        
        .chat-box, .event-log { 
            height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            padding: 8px; 
            background: #fff; 
            font-size: 0.85rem; 
            display: flex; 
            flex-direction: column; 
        }
        .chat-box p { margin: 0; line-height: 1.2; word-wrap: break-word; padding-bottom: 2px; }
        .chat-box p.system { color: gray; font-style: italic; text-align: center; }
        .chat-box p.propio { font-weight: bold; color: #007bff; }
        
        /* Estilos específicos para eventos */
        .event-log p { margin: 0; padding-bottom: 5px; word-wrap: break-word; }
        .event-log p strong { color: #5a3a7b; /* Morado para DM Gema */ }
        
        /* Botones de Acción */
        .action-button { width: 100%; margin-bottom: 6px; background-color: #4a4a4a; color: #fff; border: none; border-radius: 6px; padding: 8px; font-weight: bold; font-size: 0.85rem; transition: 0.2s; }
        .action-button:hover { background-color: #666; transform: translateY(-2px); }
        
        /* Estilo especial para el botón de Iniciar */
        #btn-iniciar-aventura, #btn-iniciar-aventura-movil { 
            background-color: #d4af37; /* Dorado */
            color: #000; 
            font-weight: bold;
        }
        #btn-iniciar-aventura:hover, #btn-iniciar-aventura-movil:hover { 
            background-color: #f1c40f; 
            transform: translateY(-2px); 
        }
        
        .codigo-box { background: #333; color: #fff; border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center; gap: 8px; }
        .copy-btn { border: none; background: #555; color: #fff; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; cursor: pointer; }
        .copy-btn:hover { background: #777; }
        
        /* Estilos Tablero */
        #tablero-container span, #tablero-container-movil span { color: #555; display: flex; justify-content: center; align-items: center; height: 100%; }

        /* Estilos Modal Medieval */
        .modal-medieval-header { background-color: #333; color: #fff; border-bottom: 1px solid #555; }
        .modal-medieval-body { background-color: #222; color: #ddd; }
    </style>
</head>

<body class="container-fluid py-2">

    <div class="text-center mb-3">
        <h4>⚔️ Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            Código: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-board">Tablero</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-players">Jugadores</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events">Eventos</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chat">Chat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-actions">Acciones</button></li>
    </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch">
        
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small">
                    <li class="list-group-item text-center">Cargando...</li>
                </ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-container" style="height:350px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                    <span style="color:#555;">[ aquí agregaremos el tablero ]</span>
                </div>
            </div>
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div id="event-log-box" class="event-log small"></div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1 d-flex flex-column">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1">
                </div>
                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">➤</button>
                </div>
            </div>
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button" id="btn-iniciar-aventura">▶ INICIAR AVENTURA</button>
                    
                    <button class="action-button">Moverse</button>
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Habilidad</button>
                    <button class="action-button">Objeto</button>
                    <button class="action-button">Dialogar</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content d-md-none mt-2">
        <div class="tab-pane fade show active panel" id="tab-board">
            <h6 class="panel-title">Tablero</h6>
            <div id="tablero-container-movil" style="height:250px; background:#ddd; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                <span style="color:#555;">[ aquí agregaremos el tablero ]</span>
            </div>
        </div>
        <div class="tab-pane fade panel" id="tab-players">
            <h6 class="panel-title">Jugadores</h6>
            <ul id="lista-jugadores-movil" class="list-group small"><li class="list-group-item text-center">Cargando...</li></ul>
        </div>
        <div class="tab-pane fade panel" id="tab-events">
             <h6 class="panel-title">Eventos</h6>
             <div id="eventos-movil" class="event-log small" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <div class="tab-pane fade panel" id="tab-chat">
            <h6 class="panel-title">Chat</h6>
            <div id="chat-box-movil" class="chat-box small flex-grow-1"></div>
            <div class="input-group mt-2 input-group-sm">
                <input id="chat-input-movil" type="text" class="form-control" placeholder="Mensaje...">
                <button id="chat-send-btn-movil" class="btn btn-primary">➤</button>
            </div>
        </div>
        <div class="tab-pane fade panel" id="tab-actions">
            <h6 class="panel-title">Acciones</h6>
            <div class="d-grid gap-1">
                <button class="action-button" id="btn-iniciar-aventura-movil">▶ INICIAR AVENTURA</button>
                
                <button class="action-button">Moverse</button>
                <button class="action-button">Atacar</button>
                <button class="action-button">Habilidades</button>
                <button class="action-button action-equipo">Equipo</button>
                <button class="action-button action-inventario">Inventario</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInfoPersonaje" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-medieval">
                <div class="modal-header modal-medieval-header">
                    <h5 class="modal-title" id="modalTitle">Información</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-medieval-body" id="modalBody">
                    Cargando...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // *** VARIABLES DE CONTEXTO OBTENIDAS DEL SERVIDOR ***
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10); 
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);
        
        let socket; 
        let modalPersonaje = null;

        // Elementos del DOM
        const chatBoxPC = document.getElementById('chat-box-pc');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const btnSendPC = document.getElementById('chat-send-btn-pc');
        const tableroPC = document.getElementById('tablero-container');
        const eventLogBox = document.getElementById('event-log-box');
        const btnIniciarPC = document.getElementById('btn-iniciar-aventura');
        
        const chatBoxMovil = document.getElementById('chat-box-movil');
        const inputMsgMovil = document.getElementById('chat-input-movil');
        const btnSendMovil = document.getElementById('chat-send-btn-movil');
        const tableroMovil = document.getElementById('tablero-container-movil');
        const eventLogMovil = document.getElementById('eventos-movil');
        const btnIniciarMovil = document.getElementById('btn-iniciar-aventura-movil');

        document.addEventListener('DOMContentLoaded', () => {
            
            if (ID_PARTIDA === 0 || ID_PERSONAJE === 0 || USER_ID === 0) {
                 console.error("Error: Falta ID_PARTIDA, ID_PERSONAJE o USER_ID.");
                 if (chatBoxPC) chatBoxPC.innerHTML = '<p class="system">[Error Crítico: Faltan IDs.]</p>';
                 return;
            }

            socket = io("http://127.0.0.1:5000", {
                transports: ['websocket'],
                withCredentials: true
            });

            // Cargar datos iniciales
            cargarJugadores();
            cargarHistorialChat();
            cargarHistorialEventos(); 

            // Listeners Chat
            if (btnSendPC) btnSendPC.addEventListener("click", enviarMensaje);
            if (inputMsgPC) inputMsgPC.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); } });
            if (btnSendMovil) btnSendMovil.addEventListener("click", enviarMensaje);
            if (inputMsgMovil) inputMsgMovil.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); enviarMensaje(); } });

            // *** LISTENER BOTÓN INICIAR ***
            const accionIniciar = () => {
                Swal.fire({
                    title: '¿Iniciar Aventura?',
                    text: "Esto creará la primera escena y la narración de la IA.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#d4af37',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, ¡comencemos!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Usamos la función enviarMensaje pero forzando el texto
                        socket.emit("send_message", {
                            id_partida: ID_PARTIDA,
                            id_personaje: ID_PERSONAJE,
                            mensaje: "@iniciar"
                        });
                    }
                });
            };
            if (btnIniciarPC) btnIniciarPC.addEventListener("click", accionIniciar);
            if (btnIniciarMovil) btnIniciarMovil.addEventListener("click", accionIniciar);


            // Listeners Botones Acción (Equipo/Inventario)
            document.querySelectorAll(".action-equipo").forEach(btn => btn.addEventListener("click", cargarEquipo));
            document.querySelectorAll(".action-inventario").forEach(btn => btn.addEventListener("click", cargarInventario));


            // Eventos Socket
            socket.on("connect", () => {
                console.log("Socket conectado");
                socket.emit("join_partida", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE });
            });

            socket.on("system", data => { agregarMensaje(`[Sistema] ${data.msg}`, "system"); });
            
            socket.on("new_message", data => {
                const esPropio = (String(data.id_usuario) === String(USER_ID));
                const tipo = esPropio ? "propio" : "normal";
                
                // Si es comando oculto, no mostrar
                if (data.mensaje === "@iniciar") return;

                if (data.username === "DM Gema" || data.username === "Sistema") {
                    if (data.mensaje.includes("Generando") || data.mensaje.includes("Viajando")) {
                        actualizarTablero(data.mensaje, false);
                    }
                    return; 
                }
                
                const texto = data.nombre_personaje
                    ? `${data.nombre_personaje} (${data.username}): ${data.mensaje}`
                    : `${data.username}: ${data.mensaje}`;
                
                agregarMensaje(texto, tipo);
            });

            socket.on("error", data => { console.error("Socket Error:", data.msg); agregarMensaje(`[Error] ${data.msg}`, "system"); });
            
            socket.on("mapa_nuevo", data => {
                 if (data.url_imagen) actualizarTablero(`<img src="${data.url_imagen}" style="width:100%; height:100%; object-fit:contain; border-radius:6px;">`, true);
                 else if (data.msg) actualizarTablero(data.msg, false);
            });
            socket.on("tablero_code", data => {
                if (data.codigo) actualizarTablero(data.codigo, true); 
                else actualizarTablero("Error: Código vacío.", false);
            });
            
            socket.on("joined", data => { console.log("Unido:", data.room); });

            // IA Eventos
            socket.on('nuevo_evento_ia', (data) => {
                agregarEvento(`<strong>DM Gema:</strong> ${data.descripcion}`);
            });

        }); // FIN DOMContentLoaded

        // --- Funciones Globales ---

        function agregarMensaje(texto, tipo = "normal", isHtml = false) {
            const p = document.createElement("p");
            p.className = tipo;
            if (isHtml) p.innerHTML = texto; else p.textContent = texto;

            if (chatBoxPC) { chatBoxPC.appendChild(p.cloneNode(true)); chatBoxPC.scrollTop = chatBoxPC.scrollHeight; }
            if (chatBoxMovil) { chatBoxMovil.appendChild(p.cloneNode(true)); chatBoxMovil.scrollTop = chatBoxMovil.scrollHeight; }
        }
        
        function agregarEvento(html) {
            const p1 = document.createElement("p"); p1.innerHTML = html;
            if (eventLogBox) { eventLogBox.appendChild(p1); eventLogBox.scrollTop = eventLogBox.scrollHeight; }
            const p2 = document.createElement("p"); p2.innerHTML = html;
            if (eventLogMovil) { eventLogMovil.appendChild(p2); eventLogMovil.scrollTop = eventLogMovil.scrollHeight; }
        }

        async function cargarHistorialChat() {
            if (chatBoxPC) chatBoxPC.innerHTML = "";
            if (chatBoxMovil) chatBoxMovil.innerHTML = "";
            agregarMensaje("[ Cargando historial... ]", "system");
            try {
                const resp = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
                const msgs = await resp.json();
                if (!msgs || msgs.length === 0) {
                    agregarMensaje("[ Sin mensajes anteriores ]", "system");
                    return;
                }
                msgs.forEach(msg => {
                    if (String(msg.id_usuario) === "101") return; // Filtrar IA
                    const tipo = (String(msg.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                    const personaje = msg.nombre_personaje || msg.username || 'Sistema'; 
                    const username_display = (msg.nombre_personaje && msg.username) ? ` (${msg.username})` : '';
                    const texto = `${personaje}${username_display}: ${msg.mensaje}`;
                    agregarMensaje(texto, tipo);
                });
            } catch (err) { console.error("Error chat:", err); agregarMensaje("[ Error historial ]", "system"); }
        }
        
        async function cargarHistorialEventos() {
            if (eventLogBox) eventLogBox.innerHTML = "";
            if (eventLogMovil) eventLogMovil.innerHTML = "";
            try {
                const resp = await fetch(`/api/chat/eventos/${ID_PARTIDA}`);
                if (!resp.ok) return;
                const eventos = await resp.json();
                if (eventos.length > 0) {
                    eventos.forEach(evt => {
                        agregarEvento(`<strong>DM Gema:</strong> ${evt.descripcion}`);
                    });
                }
            } catch (e) { console.error("Error eventos:", e); }
        }

        function enviarMensaje() {
            const el = document.activeElement === inputMsgMovil ? inputMsgMovil : inputMsgPC;
            if (!el || !socket) return; 
            const msg = el.value.trim();
            if (!msg) return;
            
            if (inputMsgPC) inputMsgPC.disabled = true;
            if (btnSendPC) btnSendPC.disabled = true;
            if (inputMsgMovil) inputMsgMovil.disabled = true;
            if (btnSendMovil) btnSendMovil.disabled = true;

            socket.emit("send_message", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE, mensaje: msg });
            el.value = ""; el.focus();

            if (inputMsgPC) inputMsgPC.disabled = false;
            if (btnSendPC) btnSendPC.disabled = false;
            if (inputMsgMovil) inputMsgMovil.disabled = false;
            if (btnSendMovil) btnSendMovil.disabled = false;
        }

        function actualizarTablero(content, isHtml = false) {
            if (tableroPC) {
                tableroPC.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroPC.style.background = isHtml ? 'none' : '#ddd';
            }
            if (tableroMovil) {
                tableroMovil.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroMovil.style.background = isHtml ? 'none' : '#ddd';
            }
        }

        async function cargarJugadores() {
            try {
                const ulPc = document.getElementById("lista-jugadores");
                const ulMovil = document.getElementById("lista-jugadores-movil");
                const resp = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const j = await resp.json();
                if (ulPc) ulPc.innerHTML = "";
                if (ulMovil) ulMovil.innerHTML = "";
                if (!j || j.length === 0) {
                    if (ulPc) ulPc.innerHTML = `<li class="list-group-item text-center text-muted">No hay jugadores</li>`;
                    if (ulMovil) ulMovil.innerHTML = ulPc.innerHTML;
                    return;
                }
                j.forEach(p => {
                    const li = `<li class="list-group-item py-1">${p.personaje} (${p.clase}) HP: ${p.puntos_vida_actual}/${p.puntos_vida_maximo}</li>`;
                    if (ulPc) ulPc.innerHTML += li;
                    if (ulMovil) ulMovil.innerHTML += li;
                });
            } catch (err) {}
        }

        function abrirModalInfoBase() {
            if (!modalPersonaje) {
                const el = document.getElementById("modalInfoPersonaje");
                modalPersonaje = new bootstrap.Modal(el);
            }
            modalPersonaje.show();
        }

        async function cargarEquipo() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/equipo/${ID_PERSONAJE}`, "Equipo Equipado", "equipo");
        }

        async function cargarInventario() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/inventario/${ID_PERSONAJE}`, "Inventario", "inventario");
        }

        async function cargarModalInfo(url, titulo, tipoVista) {
            const mTitle = document.getElementById("modalTitle");
            const mBody = document.getElementById("modalBody");
            mTitle.textContent = titulo;
            mBody.innerHTML = "<p class='text-center text-muted'>Cargando...</p>";

            try {
                const resp = await fetch(url); 
                if (!resp.ok) throw new Error("Error datos");
                const items = await resp.json();

                if (!Array.isArray(items) || !items.length) {
                    mBody.innerHTML = "<p class='text-center'>Vacío.</p>";
                    return;
                }

                let html = "<ul class='list-group'>";
                items.forEach(i => {
                    const nombre = i.NOMBRE_OBJETO || i.nombre || "Objeto";
                    const cant = i.CANTIDAD || 1;
                    const idObj = Number(i.ID_EQUIPO);
                    html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#222; color:white; border-color:#333;">
                        <div><div>${nombre}</div><small class="text-muted">x${cant}</small></div>
                        ${tipoVista === "equipo"
                            ? `<button class="btn btn-sm btn-danger ms-2" data-accion="desequipar" data-id="${idObj}">Desequipar</button>`
                            : `<button class="btn btn-sm btn-success ms-2" data-accion="equipar" data-id="${idObj}">Equipar</button>`
                        }
                    </li>`;
                });
                html += "</ul>";
                mBody.innerHTML = html;

                mBody.querySelectorAll("button[data-accion]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        manejarEquiparDesequipar(btn.getAttribute("data-accion"), btn.getAttribute("data-id"), tipoVista);
                    });
                });
            } catch (err) { mBody.innerHTML = "<p class='text-danger'>Error.</p>"; }
        }

        async function manejarEquiparDesequipar(accion, idObjeto, tipoVista) {
            const url = accion === "equipar" ? "/api/partidas/equipo/equipar" : "/api/partidas/equipo/desequipar";
            try {
                const resp = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id_personaje: Number(ID_PERSONAJE), id_objeto: Number(idObjeto) })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || "Error al realizar la acción");

                Swal.fire({ title: "Éxito", text: "Hecho.", icon: "success", timer: 1000, showConfirmButton: false });
                if (tipoVista === "equipo") cargarEquipo(); else cargarInventario();
            } catch (err) { Swal.fire({ title: "Error", text: err.message || "Falló", icon: "error" }); }
        }

        function copiarCodigo() {
            const c = document.getElementById("codigoPartida").textContent;
            navigator.clipboard.writeText(c);
            Swal.fire({ title: "Copiado", text: c, icon: "success", timer: 1500, showConfirmButton: false });
        }
    </script>
</body>
</html>