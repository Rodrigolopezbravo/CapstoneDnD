<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}?v=8">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        #tablero-wrapper, #tablero-wrapper-movil {
            height: 350px !important; /* Forzamos altura fija */
            width: 100%; 
            aspect-ratio: 1/1;
            background: #bbb;
            margin: 0 auto;
        }
        .event-log { min-height: 100px; flex-grow: 1; }
        .chat-box { height: 100%; flex-grow: 1; min-height: 200px; }
        
        /* Mobile adjustments */
        @media(max-width:768px){
            #tablero-wrapper-movil { width: 95%; height: auto !important; max-width: 400px; }
        }
    </style>
</head>
<body class="container-fluid py-2">

    <div class="text-center mb-2" style="height: 35px;">
        <h5 class="m-0 text-white">⚔️ {{ partida.nombre }} <small style="font-size:0.8rem; color:#aaa;">(Cod: <span id="codigoPartida">{{ partida.codigo }}</span>)</small> <button class="copy-btn" onclick="copiarCodigo()">Copiar</button></h5>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-board">Tablero</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chat">Chat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-actions">Acciones</button></li>
    </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch" style="height: calc(100vh - 55px);">
        
        <div class="col-md-2 d-flex flex-column">
            <div class="panel panel-grow">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small" style="overflow-y:auto; flex-grow:1; padding:0;"></ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column h-100">
            <div class="panel panel-fixed mb-2">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-wrapper">
                    <div id="tablero-grid"><div id="party-token"></div></div>
                </div>
                <div class="d-flex justify-content-center mt-1">
                    <div class="btn-group btn-group-sm">
                        <button onclick="moverTablero('N')" class="btn btn-secondary">↑</button>
                        <button onclick="moverTablero('O')" class="btn btn-secondary">←</button>
                        <button onclick="moverTablero('S')" class="btn btn-secondary">↓</button>
                        <button onclick="moverTablero('E')" class="btn btn-secondary">→</button>
                    </div>
                </div>
            </div>
            <div class="panel panel-grow">
                <h6 class="panel-title">Narración</h6>
                <div id="event-log-box" class="event-log small"></div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column h-100">
            <div class="panel panel-grow mb-2">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small"></div>
                <div class="input-group mt-2 input-group-sm flex-shrink-0">
                    <input id="chat-input-pc" type="text" class="form-control form-control-sm" placeholder="...">
                    <button id="chat-send-btn-pc" class="btn btn-primary btn-sm">➤</button>
                </div>
            </div>
            <div class="panel panel-fixed">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1" style="overflow-y: auto; max-height: 250px;">
                    <button class="action-button" id="btn-iniciar-aventura">▶ INICIAR AVENTURA</button>
                    <button class="action-button btn-danger" onclick="atacarObjetivo()">⚔️ Atacar</button>
                    <button class="action-button" onclick="menuHabilidades()">Habilidades</button>
                    <button class="action-button" onclick="menuObjetos()">Objeto</button>
                    <button class="action-button" onclick="dialogar()">Dialogar</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content d-md-none mt-2" style="height: calc(100vh - 100px);">
        <div class="tab-pane fade show active panel" id="tab-board">
            <div id="tablero-wrapper-movil">
                <div id="tablero-grid-movil"><div id="party-token-movil"></div></div>
                <div class="mt-2 text-center">
                    <div class="btn-group"><button onclick="moverTablero('N')" class="btn btn-secondary">↑</button><button onclick="moverTablero('O')" class="btn btn-secondary">←</button><button onclick="moverTablero('S')" class="btn btn-secondary">↓</button><button onclick="moverTablero('E')" class="btn btn-secondary">→</button></div>
                </div>
            </div>
            <div class="mt-2 flex-grow-1 panel" style="min-height:0;"><div id="eventos-movil" class="event-log h-100"></div></div>
        </div>
        <div class="tab-pane fade panel" id="tab-chat">
            <div id="chat-box-movil" class="chat-box h-100"></div>
            <div class="input-group mt-2"><input id="chat-input-movil" class="form-control"><button id="chat-send-btn-movil" class="btn btn-primary">➤</button></div>
        </div>
        <div class="tab-pane fade panel" id="tab-actions">
            <div class="d-grid gap-1 h-100" style="overflow-y: auto;">
                <button class="action-button" id="btn-iniciar-aventura-movil">▶ INICIAR</button>
                <button class="action-button btn-danger" onclick="atacarObjetivo()">Atacar</button>
                <button class="action-button" onclick="menuHabilidades()">Habilidades</button>
                <button class="action-button" onclick="menuObjetos()">Objeto</button>
                <button class="action-button" onclick="dialogar()">Dialogar</button>
                <button class="action-button action-equipo">Equipo</button>
                <button class="action-button action-inventario">Inventario</button>
            </div>
        </div>
        <div class="tab-pane fade panel" id="tab-players"><ul id="lista-jugadores-movil" class="list-group small"></ul></div>
    </div>

    <div class="modal fade" id="modalInfoPersonaje" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-medieval">
                <div class="modal-header modal-medieval-header"><h5 class="modal-title" id="modalTitle">Info</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body modal-medieval-body" id="modalBody">Cargando...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10);
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);
        let socket, modalPersonaje = null, listaMonstruos = [], coordX = 7, coordY = 7;

        document.addEventListener('DOMContentLoaded', () => {
            if (ID_PARTIDA === 0) return;
            socket = io(location.protocol + '//' + document.domain + ':' + location.port, { transports: ['websocket'], withCredentials: true });

            crearGrid(); actualizarToken(); cargarJugadores(); cargarMonstruos(); 
            cargarHistorialChat(); cargarHistorialEventos();
            setupListeners(); setupSocketEvents();
            window.addEventListener('resize', () => { actualizarToken(); dibujarMonstruos(); });
        });

        function crearGrid() {
            const g1 = document.getElementById("tablero-grid"), g2 = document.getElementById("tablero-grid-movil");
            g1.innerHTML = '<div id="party-token"></div>'; g2.innerHTML = '<div id="party-token-movil"></div>';
            for (let i = 0; i < 225; i++) { const c = document.createElement("div"); c.className = "celda"; g1.appendChild(c); g2.appendChild(c.cloneNode(true)); }
        }

        function actualizarToken() {
            [{el:document.getElementById("party-token"), g:document.getElementById("tablero-grid")}, 
             {el:document.getElementById("party-token-movil"), g:document.getElementById("tablero-grid-movil")}].forEach(i=>{
                if(i.el && i.g) {
                    const w = i.g.clientWidth/15, h = i.g.clientHeight/15, sz = w*0.7;
                    i.el.style.width=`${sz}px`; i.el.style.height=`${sz}px`;
                    i.el.style.left = `${(coordX*w)+(w-sz)/2}px`; i.el.style.top = `${(coordY*h)+(h-sz)/2}px`;
                }
            });
        }

        function dibujarMonstruos() {
            const grids = [document.getElementById("tablero-grid"), document.getElementById("tablero-grid-movil")];
            grids.forEach(g => {
                if(!g) return;
                g.querySelectorAll('.token-monstruo').forEach(e => e.remove());
                const w = g.clientWidth/15, h = g.clientHeight/15, sz = w*0.6;
                listaMonstruos.forEach(m => {
                    const t = document.createElement("div"); t.className = "token-monstruo"; t.title = m.nombre;
                    t.style.width=`${sz}px`; t.style.height=`${sz}px`;
                    t.style.left = `${(m.x*w)+(w-sz)/2}px`; t.style.top = `${(m.y*h)+(h-sz)/2}px`;
                    t.onclick = (e) => { e.stopPropagation(); confirmarAtaque(m.id, m.nombre); };
                    g.appendChild(t);
                });
            });
        }

        function moverTablero(d) {
            if(d==='E'&&coordX<14)coordX++; if(d==='O'&&coordX>0)coordX--; if(d==='S'&&coordY<14)coordY++; if(d==='N'&&coordY>0)coordY--;
            actualizarToken();
        }

        async function confirmarAtaque(idM, nom) {
            Swal.fire({title:`¿Atacar a ${nom}?`, icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'¡Golpear!'}).then(async r=>{
                if(r.isConfirmed) {
                    // Enviar ID del Monstruo (ROWID)
                    await fetch('/api/partidas/accion/atacar', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id_personaje:ID_PERSONAJE, id_partida:ID_PARTIDA, id_objetivo:idM})});
                }
            });
        }

        async function atacarObjetivo() {
            Swal.fire({title:'Atacar', text:"¿Atacar sin objetivo?", icon:'question', showCancelButton:true, confirmButtonText:'¡Sí!'}).then(async r=>{
                if(r.isConfirmed) {
                    await fetch('/api/partidas/accion/atacar', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id_personaje:ID_PERSONAJE, id_partida:ID_PARTIDA})});
                }
            });
        }

        function dialogar() { 
            Swal.fire({title:'Hablar / Actuar', input:'textarea', showCancelButton:true, confirmButtonText:'Enviar', confirmButtonColor:'#d4af37'}).then(res => {
                if (res.value) socket.emit("send_message", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE, mensaje: "@evento " + res.value });
            });
        }

        async function menuHabilidades() {
            try {
                const r = await fetch(`/api/partidas/accion/habilidades/${ID_PERSONAJE}`);
                const skills = await r.json();
                if(!skills.length) return Swal.fire('Sin Habilidades', 'Nada disponible', 'info');
                const opts = {}; skills.forEach(s=>opts[s.id]=s.nombre);
                const {value:id} = await Swal.fire({title:'Usar Habilidad', input:'select', inputOptions:opts, showCancelButton:true});
                if(id) await fetch('/api/partidas/accion/habilidad', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id_personaje:ID_PERSONAJE, id_habilidad:id, id_partida:ID_PARTIDA})});
            } catch(e) {}
        }

        async function menuObjetos() {
            try {
                const r = await fetch(`/api/partidas/accion/consumibles/${ID_PERSONAJE}`);
                const items = await r.json();
                if(!items.length) return Swal.fire('Mochila', 'Sin pociones', 'info');
                const opts = {}; items.forEach(i=>opts[i.id]=`${i.nombre} (x${i.cantidad})`);
                const {value:id} = await Swal.fire({title:'Usar Objeto', input:'select', inputOptions:opts, showCancelButton:true});
                if(id) await fetch('/api/partidas/accion/pocion', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id_personaje:ID_PERSONAJE, id_objeto:id, id_partida:ID_PARTIDA})});
            } catch(e) {}
        }

        async function cargarMonstruos() { try{ const r=await fetch(`/api/partidas/tablero/monstruos/${ID_PARTIDA}`); if(r.ok){listaMonstruos=await r.json(); dibujarMonstruos();} }catch{} }
        
        async function cargarJugadores() { 
            try{ const r=await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`); const j=await r.json(); 
            const h = j.map(p=> {
                let color = p.porcentaje < 30 ? "bg-danger" : (p.porcentaje < 60 ? "bg-warning" : "bg-success");
                return `<li class="list-group-item player-card"><div class="d-flex justify-content-between align-items-center mb-1"><span class="player-name">${p.personaje}</span><span class="badge player-badge">${p.clase}</span></div><div class="progress" style="height:8px; background-color:#222; border:1px solid #555;"><div class="progress-bar ${color}" style="width:${p.porcentaje}%"></div></div><div class="text-end mt-1"><span class="hp-text">${p.hp_actual} / ${p.hp_max} HP</span></div></li>`;
            }).join('');
            document.getElementById("lista-jugadores").innerHTML=h; document.getElementById("lista-jugadores-movil").innerHTML=h;
            }catch{} 
        }

        function setupSocketEvents() {
            socket.on("connect", ()=>socket.emit("join_partida", {id_partida:ID_PARTIDA, id_personaje:ID_PERSONAJE}));
            socket.on("system", d=>addMsg(d.msg, "system"));
            socket.on("new_message", d=> { if(d.mensaje!=="@iniciar") addMsg(d.mensaje, String(d.id_usuario)===String(USER_ID)?"propio":"normal", d.username); });
            socket.on('nuevo_evento_ia', d=> { addEvt(d.descripcion); document.querySelectorAll("[id^='btn-iniciar']").forEach(b=>b.style.display='none'); setTimeout(cargarMonstruos,1500); });
            socket.on('accion_realizada', () => { cargarHistorialEventos(); cargarJugadores(); cargarMonstruos(); });
        }

        function addMsg(txt, tipo, user="") {
            const d = document.createElement("div"); d.className = `chat-message ${tipo}`;
            d.innerHTML = user ? `<span class="message-author">${user}</span>${txt}` : txt;
            ['chat-box-pc','chat-box-movil'].forEach(id=>{ const b=document.getElementById(id); if(b){b.appendChild(d.cloneNode(true)); b.scrollTop=b.scrollHeight;} });
        }
        function addEvt(html) {
            const p = document.createElement("p"); p.innerHTML = `<strong>DM Gema:</strong> ${html}`;
            ['event-log-box','eventos-movil'].forEach(id=>{ const b=document.getElementById(id); if(b){b.appendChild(p.cloneNode(true)); b.scrollTop=b.scrollHeight;} });
        }

        function setupListeners() {
            const send = () => {
                const i = document.getElementById('chat-input-pc').value ? document.getElementById('chat-input-pc') : document.getElementById('chat-input-movil');
                if(i.value.trim()) { socket.emit("send_message", {id_partida:ID_PARTIDA, id_personaje:ID_PERSONAJE, mensaje:i.value.trim()}); i.value=""; }
            };
            document.querySelectorAll("[id^='chat-send']").forEach(b=>b.onclick=send);
            document.querySelectorAll("[id^='chat-input']").forEach(i=>i.onkeypress=e=>{if(e.key==='Enter')send()});
            document.querySelectorAll(".action-equipo").forEach(b=>b.onclick=()=>loadItems("equipo"));
            document.querySelectorAll(".action-inventario").forEach(b=>b.onclick=()=>loadItems("inventario"));
            const btnIni = document.getElementById("btn-iniciar-aventura");
            if(btnIni) btnIni.onclick = () => Swal.fire({title:'¿Iniciar?', showCancelButton:true}).then(r=>{if(r.isConfirmed){socket.emit("send_message", {id_partida:ID_PARTIDA, id_personaje:ID_PERSONAJE, mensaje:"@iniciar"});}});
        }

        async function loadItems(t) {
            if(!modalPersonaje) modalPersonaje = new bootstrap.Modal(document.getElementById("modalInfoPersonaje"));
            document.getElementById("modalTitle").textContent = t.toUpperCase(); document.getElementById("modalBody").innerHTML="Cargando...";
            modalPersonaje.show();
            try { const r=await fetch(`/api/partidas/${t}/${ID_PERSONAJE}`); const d=await r.json();
                const h = d.map(i=> {
                    const id=i.ID_EQUIPO||i.ID_INSTANCIA_OBJETO, n=i.NOMBRE||i.NOMBRE_OBJETO;
                    const btn=t==='equipo'?`<button class='btn btn-sm btn-danger' onclick='actItem("desequipar",${id},"${t}")'>X</button>`:`<button class='btn btn-sm btn-success' onclick='actItem("equipar",${id},"${t}")'>✓</button>`;
                    return `<li class="list-group-item bg-dark text-light d-flex justify-content-between border-secondary"><span>${n}</span>${btn}</li>`;
                }).join('');
                document.getElementById("modalBody").innerHTML = `<ul class="list-group list-group-flush">${h||'<li class="list-group-item bg-dark text-muted">Vacío</li>'}</ul>`;
            }catch{ document.getElementById("modalBody").innerHTML="Error"; }
        }
        window.actItem = async (a,id,v) => { await fetch(`/api/partidas/equipo/${a}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id_personaje:ID_PERSONAJE, id_objeto:id})}); loadItems(v); cargarJugadores(); };
        
        function copiarCodigo() { navigator.clipboard.writeText(document.getElementById("codigoPartida").textContent); Swal.fire({icon:'success',title:'Copiado',timer:1000,showConfirmButton:false}); }
        async function cargarHistorialChat(){try{const r=await fetch(`/api/chat/partida/${ID_PARTIDA}`);(await r.json()).forEach(m=>{if(m.id_usuario!=='101')addMsg(m.mensaje, String(m.id_usuario)===String(USER_ID)?'propio':'normal', m.username)})}catch{}}
        async function cargarHistorialEventos(){try{const r=await fetch(`/api/chat/eventos/${ID_PARTIDA}`);const e=await r.json();if(e.length){document.querySelectorAll("[id^='btn-iniciar']").forEach(b=>b.style.display='none');e.forEach(ev=>addEvt(ev.descripcion))}}catch{}}
    </script>
</body>
</html>