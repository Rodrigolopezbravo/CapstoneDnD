<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partida D&D - {{ partida.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partida.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Estilos de respaldo */
        body {
            background-color: #222;
            color: #fff;
            min-height: 100vh;
        }

        .panel {
            background-color: #f4f7f6;
            color: #333;
            border-radius: 6px;
            padding: 10px;
            height: 100%;
        }

        .chat-box,
        .event-log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            background: #fff;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
        }

        .event-log p strong {
            color: #5a3a7b;
        }

        #btn-iniciar-aventura,
        #btn-iniciar-aventura-movil {
            background-color: #d4af37;
            color: #000;
            font-weight: bold;
            border: 1px solid #b8934d;
        }

        #btn-iniciar-aventura:hover {
            background-color: #f1c40f;
        }
    </style>
</head>

<body class="container-fluid py-2">

    <div class="text-center mb-3">
        <h4>⚔️ Partida: {{ partida.nombre }}</h4>
        <div class="codigo-box mt-2">
            Código: <strong id="codigoPartida">{{ partida.codigo }}</strong>
            <button class="copy-btn" onclick="copiarCodigo()">Copiar</button>
        </div>
    </div>

    <ul class="nav nav-tabs d-md-none" id="partidaTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab"
                data-bs-target="#tab-board">Tablero</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#tab-players">Jugadores</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events">Eventos</button>
        </li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-chat">Chat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab"
                data-bs-target="#tab-actions">Acciones</button></li>
    </ul>

    <div class="row d-none d-md-flex g-2 align-items-stretch">
        <div class="col-md-2 d-flex flex-column">
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Jugadores</h6>
                <ul id="lista-jugadores" class="list-group list-group-flush small">
                    <li class="list-group-item text-center">Cargando...</li>
                </ul>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1">
                <h6 class="panel-title">Tablero</h6>
                <div id="tablero-wrapper">
                    <div id="tablero-grid">
                        <div id="party-token"></div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-2">
                    <div class="btn-group">
                        <button onclick="moverTablero('N')" class="btn btn-secondary btn-sm">↑</button>
                        <button onclick="moverTablero('O')" class="btn btn-secondary btn-sm">←</button>
                        <button onclick="moverTablero('S')" class="btn btn-secondary btn-sm">↓</button>
                        <button onclick="moverTablero('E')" class="btn btn-secondary btn-sm">→</button>
                    </div>
                </div>
            </div>
            <div class="panel p-2" style="max-height:180px; overflow-y:auto;">
                <h6 class="panel-title">Eventos</h6>
                <div id="event-log-box" class="event-log small"></div>
            </div>
        </div>

        <div class="col-md-3 d-flex flex-column">
            <div class="panel p-2 mb-2 flex-grow-1 d-flex flex-column">
                <h6 class="panel-title">Chat</h6>
                <div id="chat-box-pc" class="chat-box small flex-grow-1"></div>
                <div class="input-group mt-2 input-group-sm">
                    <input id="chat-input-pc" type="text" class="form-control" placeholder="Mensaje...">
                    <button id="chat-send-btn-pc" class="btn btn-primary">➤</button>
                </div>
            </div>
            <div class="panel p-2 flex-grow-1">
                <h6 class="panel-title">Acciones</h6>
                <div class="d-grid gap-1">
                    <button class="action-button" id="btn-iniciar-aventura">▶ INICIAR AVENTURA</button>
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Habilidades</button>
                    <button class="action-button">Objeto</button>
                    <button class="action-button">Dialogar</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content d-md-none mt-2">
        <div class="tab-pane fade show active panel" id="tab-board">
            <div id="tablero-wrapper-movil">
                <div id="tablero-grid-movil">
                    <div id="party-token-movil"></div>
                </div>

                <div class="mobile-controls">
                    <div class="btn-group">
                        <button onclick="moverTablero('N')" class="btn btn-secondary btn-sm">↑</button>
                        <button onclick="moverTablero('O')" class="btn btn-secondary btn-sm">←</button>
                        <button onclick="moverTablero('S')" class="btn btn-secondary btn-sm">↓</button>
                        <button onclick="moverTablero('E')" class="btn btn-secondary btn-sm">→</button>
                    </div>
                </div>
            </div>

        </div>
        <div class="tab-pane fade panel" id="tab-players">
            <ul id="lista-jugadores-movil" class="list-group small"></ul>
        </div>
        <div class="tab-pane fade panel" id="tab-events">
            <div id="eventos-movil" class="event-log small" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <div class="tab-pane fade panel" id="tab-chat">
            <div id="chat-box-movil" class="chat-box small flex-grow-1"></div>
            <div class="input-group mt-2 input-group-sm">
                <input id="chat-input-movil" type="text" class="form-control" placeholder="Mensaje...">
                <button id="chat-send-btn-movil" class="btn btn-primary">➤</button>
            </div>
        </div>
        <div class="tab-pane fade panel" id="tab-actions">
            <div class="d-grid gap-1">
                    <button class="action-button" id="btn-iniciar-aventura">▶ INICIAR AVENTURA</button>
                    <button class="action-button">Atacar</button>
                    <button class="action-button">Habilidades</button>
                    <button class="action-button">Objeto</button>
                    <button class="action-button">Dialogar</button>
                    <button class="action-button action-equipo">Equipo</button>
                    <button class="action-button action-inventario">Inventario</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalInfoPersonaje" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-medieval">
                <div class="modal-header modal-medieval-header">
                    <h5 class="modal-title" id="modalTitle">Información</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-medieval-body" id="modalBody">
                    Cargando...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const ID_PARTIDA = parseInt("{{ partida.id | default(0) }}", 10);
        const ID_PERSONAJE = parseInt("{{ id_personaje | default(0) }}", 10);
        const USER_ID = parseInt("{{ id_usuario | default(0) }}", 10);

        let socket;
        let modalPersonaje = null;

        //-------------------------------------------------------
        // TABLERO VISUAL – Grid de 15x15
        //-------------------------------------------------------

        let tableroX = 0;
        let tableroY = 0;

        let visualX = 7;
        let visualY = 7;

        // cargar posiciones desde el backend al entrar al tablero
        async function cargarPosicionTablero() {
            try {
                const res = await fetch(`/api/tablero/posicion/${ID_PARTIDA}`);
                const data = await res.json();

                tableroX = data.x;
                tableroY = data.y;

                actualizarToken();
            } catch (e) {
                console.error("Error al cargar posición tablero:", e);
            }
        }


        // actualizar posición visual del token
        function actualizarToken() {
            // PC
            const tokenPC = document.getElementById("party-token");
            const gridPC = document.getElementById("tablero-grid");

            const cellWidthPC = gridPC.clientWidth / 15;
            const cellHeightPC = gridPC.clientHeight / 15;

            tokenPC.style.left = `${visualX * cellWidthPC}px`;
            tokenPC.style.top = `${visualY * cellHeightPC}px`;

            // MOVIL
            const tokenMovil = document.getElementById("party-token-movil");
            const gridMovil = document.getElementById("tablero-grid-movil");

            if (tokenMovil && gridMovil) {
                const cellWidthMov = gridMovil.clientWidth / 15;
                const cellHeightMov = gridMovil.clientHeight / 15;

                tokenMovil.style.left = `${visualX * cellWidthMov}px`;
                tokenMovil.style.top = `${visualY * cellHeightMov}px`;
            }
        }



        // mover 
        async function moverTablero(dir) {

            // Siempre en el centro del tablero visual
            visualX = 7;
            visualY = 7;
            actualizarToken();

            // Cambiar la posición REAL
            if (dir === "E") tableroX++;
            if (dir === "O") tableroX--;
            if (dir === "N") tableroY++;
            if (dir === "S") tableroY--;

            try {
                await fetch("/api/tablero/mover", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id_partida: ID_PARTIDA,
                        x: tableroX,
                        y: tableroY
                    })
                });

                agregarEvento(`<strong>El grupo se movió a:</strong> (${tableroX}, ${tableroY})`);

            } catch (err) {
                console.error("Error moviendo tablero:", err);
            }
        }


        function crearGrid() {
            const gridPC = document.getElementById("tablero-grid");
            const gridMovil = document.getElementById("tablero-grid-movil");

            gridPC.querySelectorAll(".celda").forEach(c => c.remove());
            gridMovil.querySelectorAll(".celda").forEach(c => c.remove());

            for (let i = 0; i < 225; i++) {
                const cellPC = document.createElement("div");
                cellPC.className = "celda";
                gridPC.appendChild(cellPC);

                const cellMovil = document.createElement("div");
                cellMovil.className = "celda";
                gridMovil.appendChild(cellMovil);
            }

            const tokenPC = document.getElementById("party-token");
            const tokenMovil = document.getElementById("party-token-movil");

            if (tokenPC && !gridPC.contains(tokenPC)) gridPC.appendChild(tokenPC);
            if (tokenMovil && !gridMovil.contains(tokenMovil)) gridMovil.appendChild(tokenMovil);
        }





        // Elementos DOM
        const chatBoxPC = document.getElementById('chat-box-pc');
        const inputMsgPC = document.getElementById('chat-input-pc');
        const btnSendPC = document.getElementById('chat-send-btn-pc');
        const tableroPC = document.getElementById('tablero-container');
        const eventLogBox = document.getElementById('event-log-box');
        const btnIniciarPC = document.getElementById('btn-iniciar-aventura');

        const chatBoxMovil = document.getElementById('chat-box-movil');
        const inputMsgMovil = document.getElementById('chat-input-movil');
        const btnSendMovil = document.getElementById('chat-send-btn-movil');
        const tableroMovil = document.getElementById('tablero-wrapper-movil');
        const eventLogMovil = document.getElementById('eventos-movil');
        const btnIniciarMovil = document.getElementById('btn-iniciar-aventura-movil');

        document.addEventListener('DOMContentLoaded', () => {

            if (ID_PARTIDA === 0 || ID_PERSONAJE === 0 || USER_ID === 0) {
                console.error("Error: Falta ID_PARTIDA, ID_PERSONAJE o USER_ID.");
                return;
            }

            socket = io("http://127.0.0.1:5000", { transports: ['websocket'], withCredentials: true });

            cargarJugadores();
            cargarHistorialChat();
            cargarHistorialEventos();
            crearGrid();
            cargarPosicionTablero();

            // --- Listeners Chat ---
            if (btnSendPC) btnSendPC.addEventListener("click", enviarMensaje);
            if (inputMsgPC) inputMsgPC.addEventListener("keypress", e => { if (e.key === "Enter") enviarMensaje(); });
            if (btnSendMovil) btnSendMovil.addEventListener("click", enviarMensaje);
            if (inputMsgMovil) inputMsgMovil.addEventListener("keypress", e => { if (e.key === "Enter") enviarMensaje(); });

            // --- Listeners Botón Iniciar ---
            const accionIniciar = () => {
                if ((btnIniciarPC && btnIniciarPC.style.display === 'none') || (btnIniciarPC && btnIniciarPC.disabled)) return;
                Swal.fire({
                    title: '¿Iniciar Aventura?', text: "Se creará la primera escena.", icon: 'question', showCancelButton: true, confirmButtonColor: '#d4af37', confirmButtonText: 'Sí, iniciar'
                }).then((res) => {
                    if (res.isConfirmed) {
                        socket.emit("send_message", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE, mensaje: "@iniciar" });
                        ocultarBotonInicio();
                    }
                });
            };
            if (btnIniciarPC) btnIniciarPC.addEventListener("click", accionIniciar);
            if (btnIniciarMovil) btnIniciarMovil.addEventListener("click", accionIniciar);

            // --- Listeners Equipo e Inventario (AQUÍ ESTÁ LA CLAVE) ---
            // Usamos selectores de clase para atrapar botones de PC y Móvil
            const btnsEquipo = document.querySelectorAll(".action-equipo");
            btnsEquipo.forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    cargarEquipo();
                });
            });

            const btnsInventario = document.querySelectorAll(".action-inventario");
            btnsInventario.forEach(btn => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    cargarInventario();
                });
            });


            // --- Eventos Socket ---
            socket.on("connect", () => socket.emit("join_partida", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE }));
            socket.on("system", data => agregarMensaje(`[Sistema] ${data.msg}`, "system"));
            socket.on("new_message", data => {
                if (data.mensaje === "@iniciar") return;
                if (data.username === "DM Gema" || data.username === "Sistema") {
                    if (data.mensaje.includes("Generando")) actualizarTablero(data.mensaje, false);
                    return;
                }
                const esPropio = (String(data.id_usuario) === String(USER_ID));
                const tipo = esPropio ? "propio" : "normal";
                agregarMensaje(`${data.username}: ${data.mensaje}`, tipo);
            });
            socket.on('nuevo_evento_ia', data => {
                agregarEvento(`<strong>DM Gema:</strong> ${data.descripcion}`);
                ocultarBotonInicio();
            });
            socket.on("tablero_code", data => {
                if (data.codigo) actualizarTablero(data.codigo, true);
            });
            socket.on("mapa_nuevo", data => {
                if (data.url_imagen) actualizarTablero(`<img src="${data.url_imagen}" style="width:100%;height:100%;object-fit:contain;">`, true);
            });

        }); // FIN DOMContentLoaded

        // --- Funciones UI ---

        function ocultarBotonInicio() {
            if (btnIniciarPC) btnIniciarPC.style.display = 'none';
            if (btnIniciarMovil) btnIniciarMovil.style.display = 'none';
        }

        function agregarMensaje(txt, tipo) {
            const pPC = document.createElement("p");
            pPC.className = tipo;
            pPC.textContent = txt;

            const pMovil = pPC.cloneNode(true);

            // PC
            if (chatBoxPC) {
                chatBoxPC.appendChild(pPC);
                chatBoxPC.scrollTop = chatBoxPC.scrollHeight;
            }

            // MOVIL
            if (chatBoxMovil) {
                chatBoxMovil.appendChild(pMovil);
                chatBoxMovil.scrollTop = chatBoxMovil.scrollHeight;
            }
        }


        function agregarEvento(html) {
            const p = document.createElement("p");
            p.innerHTML = html;

            if (eventLogBox) {
                eventLogBox.appendChild(p.cloneNode(true));
                eventLogBox.scrollTop = eventLogBox.scrollHeight;
            }
            if (eventLogMovil) {
                eventLogMovil.appendChild(p.cloneNode(true));
                eventLogMovil.scrollTop = eventLogMovil.scrollHeight;
            }
        }

        function actualizarTablero(content, isHtml) {
            if (tableroPC) {
                tableroPC.innerHTML = isHtml ? content : `<span>${content}</span>`;
                tableroPC.style.background = isHtml ? 'none' : '#ddd';
            }
        }

        // --- Funciones de Carga ---

        async function cargarHistorialChat() {
            try {
                const res = await fetch(`/api/chat/partida/${ID_PARTIDA}`);
                const msgs = await res.json();
                if (!msgs || !msgs.length) return;
                msgs.forEach(m => {
                    if (String(m.id_usuario) !== "101") {
                        const tipo = (String(m.id_usuario) === String(USER_ID)) ? "propio" : "normal";
                        agregarMensaje(`${m.username}: ${m.mensaje}`, tipo);
                    }
                });
            } catch (e) { }
        }

        async function cargarHistorialEventos() {
            try {
                const res = await fetch(`/api/chat/eventos/${ID_PARTIDA}`);
                const evts = await res.json();
                if (evts.length > 0) {
                    ocultarBotonInicio();
                    evts.forEach(e => agregarEvento(`<strong>DM Gema:</strong> ${e.descripcion}`));
                }
            } catch (e) { }
        }

        async function cargarJugadores() {
            try {
                const res = await fetch(`/api/partidas/jugadores/${ID_PARTIDA}`);
                const j = await res.json();
                const ulPC = document.getElementById("lista-jugadores");
                const ulMovil = document.getElementById("lista-jugadores-movil");
                ulPC.innerHTML = "";
                ulMovil.innerHTML = "";
                j.forEach(p => {
                    const li = `<li class="list-group-item py-1">${p.personaje} (${p.clase})</li>`;
                    ulPC.innerHTML += li;
                    ulMovil.innerHTML += li;
                });
            } catch (err) { }
        }

        function enviarMensaje() {
            const inp = inputMsgPC?.value.trim()
                ? inputMsgPC
                : inputMsgMovil;
            if (!inp.value.trim()) return;
            socket.emit("send_message", { id_partida: ID_PARTIDA, id_personaje: ID_PERSONAJE, mensaje: inp.value.trim() });
            inp.value = "";
        }

        function copiarCodigo() {
            const c = document.getElementById("codigoPartida").textContent;
            navigator.clipboard.writeText(c);
            Swal.fire({ title: "Copiado", icon: "success", timer: 1000, showConfirmButton: false });
        }

        // --- FUNCIONES MODAL (EQUIPO E INVENTARIO) ---

        function abrirModalInfoBase() {
            if (!modalPersonaje) {
                const el = document.getElementById("modalInfoPersonaje");
                modalPersonaje = new bootstrap.Modal(el);
            }
            modalPersonaje.show();
        }

        async function cargarEquipo() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/equipo/${ID_PERSONAJE}`, "Equipo Equipado", "equipo");
        }

        async function cargarInventario() {
            abrirModalInfoBase();
            await cargarModalInfo(`/api/partidas/inventario/${ID_PERSONAJE}`, "Inventario", "inventario");
        }

        async function cargarModalInfo(url, titulo, tipo) {
            document.getElementById("modalTitle").textContent = titulo;
            const body = document.getElementById("modalBody");
            body.innerHTML = "<div class='text-center p-3'>Cargando...</div>";

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Error de red");
                const items = await resp.json();

                if (!Array.isArray(items) || items.length === 0) {
                    body.innerHTML = "<div class='text-center p-3 text-muted'>No hay objetos aquí.</div>";
                    return;
                }

                let html = "<ul class='list-group list-group-flush'>";
                items.forEach(i => {
                    // Ajustar nombres de campos según lo que devuelve tu API (Oracle suele devolver mayúsculas)
                    const nombre = i.NOMBRE_OBJETO || i.NOMBRE || i.nombre || "Objeto";
                    const cant = i.CANTIDAD || 1;
                    const idObj = Number(i.ID_EQUIPO || i.ID_INSTANCIA_OBJETO || 0); // Asegúrate de tener el ID único

                    // Botón según tipo
                    let btnHtml = "";
                    if (tipo === "equipo") {
                        btnHtml = `<button class='btn btn-sm btn-danger' onclick='window.manejarEquipar("equipo", ${idObj}, "desequipar")'>Desequipar</button>`;
                    } else {
                        btnHtml = `<button class='btn btn-sm btn-success' onclick='window.manejarEquipar("inventario", ${idObj}, "equipar")'>Equipar</button>`;
                    }

                    html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center" 
                        style="background:#222; color:#ddd; border-color:#444;">
                        <div>
                            <strong>${nombre}</strong> 
                            <span class="badge bg-secondary ms-2">x${cant}</span>
                        </div>
                        <div>${btnHtml}</div>
                    </li>`;
                });
                html += "</ul>";
                body.innerHTML = html;

            } catch (err) {
                console.error(err);
                body.innerHTML = "<div class='text-center text-danger p-3'>Error al cargar datos.</div>";
            }
        }

        // Definir función globalmente para que el HTML inyectado pueda llamarla
        window.manejarEquipar = async (vistaActual, idObjeto, accion) => {
            const url = accion === "equipar" ? "/api/partidas/equipo/equipar" : "/api/partidas/equipo/desequipar";

            try {
                const resp = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id_personaje: Number(ID_PERSONAJE),
                        id_objeto: Number(idObjeto)
                    })
                });

                if (!resp.ok) throw new Error("Error en la acción");

                // Recargar la vista actual para ver el cambio
                if (vistaActual === "equipo") cargarEquipo();
                else cargarInventario();

            } catch (err) {
                Swal.fire({ title: "Error", text: "No se pudo realizar la acción", icon: "error" });
            }
        };

    </script>
</body>

</html>